-- ============================================================
-- GardenHub OS v10.6 — Complete Database Migration
-- Migrates from v10.5 schema to v10.6
--
-- SAFE TO RUN MULTIPLE TIMES — all statements use
-- IF NOT EXISTS / IF EXISTS guards.
--
-- Run order matters. Execute this entire file in one
-- pass in the Supabase SQL Editor.
--
-- Supabase project: zrohwzqaksqruywiedxt
-- ============================================================


-- ============================================================
-- SECTION 1: garden_library
-- Renames: name→common_name, days_to_mature→maturity_days,
--          mature_spread_inches→spread_in
-- Adds:    scientific_name, common_name alias, maturity_days,
--          recovery_days, planted_date, is_host_plant,
--          spread_in, notes
-- Keeps:   id, user_id, emoji, plant_family, is_native,
--          pollinator_value (preserved, not removed)
-- ============================================================

-- 1a. Rename `name` → `common_name` (safe guard via DO block)
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='name'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='common_name'
  ) THEN
    ALTER TABLE garden_library RENAME COLUMN name TO common_name;
  END IF;
END $$;

-- 1b. Rename `days_to_mature` → `maturity_days`
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='days_to_mature'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='maturity_days'
  ) THEN
    ALTER TABLE garden_library RENAME COLUMN days_to_mature TO maturity_days;
  END IF;
END $$;

-- 1c. Rename `mature_spread_inches` → `spread_in`
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='mature_spread_inches'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='spread_in'
  ) THEN
    ALTER TABLE garden_library RENAME COLUMN mature_spread_inches TO spread_in;
  END IF;
END $$;

-- 1d. Add new columns (all safe with IF NOT EXISTS)
ALTER TABLE garden_library
  ADD COLUMN IF NOT EXISTS scientific_name   TEXT,
  ADD COLUMN IF NOT EXISTS is_host_plant     BOOLEAN     NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS planted_date      DATE,
  ADD COLUMN IF NOT EXISTS recovery_days     INTEGER     NOT NULL DEFAULT 0,
  ADD COLUMN IF NOT EXISTS notes             TEXT;

-- 1e. Rename spread column if it came from mature_spread_inches
--     and spread_in doesn't exist yet (handles edge case)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_library' AND column_name='spread_in'
  ) THEN
    ALTER TABLE garden_library ADD COLUMN IF NOT EXISTS spread_in INTEGER;
  END IF;
END $$;

-- 1f. Obsolete garden_library columns dropped in Section 2e (after data migrations).
-- 1g. Backfill: set recovery_days = 0 for any nulls
UPDATE garden_library SET recovery_days = 0 WHERE recovery_days IS NULL;

-- 1h. Comments
COMMENT ON COLUMN garden_library.common_name IS
  'Human-readable plant name, e.g. "Sungold Tomato"';
COMMENT ON COLUMN garden_library.maturity_days IS
  'Base days from planting to harvest. See also recovery_days for effective maturity.';
COMMENT ON COLUMN garden_library.recovery_days IS
  'Cumulative penalty days added by Clinic when resolving health scans. Added to maturity_days to compute effective maturity (Feedback Loop v10.6).';
COMMENT ON COLUMN garden_library.planted_date IS
  'Date this plant was put in the ground. Used for maturity %, harvest forecast, and calendar display.';
COMMENT ON COLUMN garden_library.is_host_plant IS
  'True if this plant hosts butterfly/moth larvae (e.g. milkweed for monarchs). Used in Pollinator IQ scoring.';


-- ============================================================
-- SECTION 2: plant_health_scans
-- The v10.5 table is structured around spatial_id FK and
-- uses numeric severity_level (1-10) + boolean is_resolved.
-- v10.6 decouples from spatial, uses text severity + status.
-- Strategy: ADD new columns, keep old ones (no data loss).
-- ============================================================

-- 2a. Add v10.6 columns
ALTER TABLE plant_health_scans
  ADD COLUMN IF NOT EXISTS plant_id             UUID REFERENCES garden_library(id) ON DELETE SET NULL,
  ADD COLUMN IF NOT EXISTS plant_name           TEXT,
  ADD COLUMN IF NOT EXISTS issue_type           TEXT,
  ADD COLUMN IF NOT EXISTS severity             TEXT    CHECK (severity IN ('low','medium','high','critical')),
  ADD COLUMN IF NOT EXISTS status               TEXT    NOT NULL DEFAULT 'pending'
                                                        CHECK (status IN ('pending','active','resolved')),
  ADD COLUMN IF NOT EXISTS scan_date            DATE    DEFAULT CURRENT_DATE,
  ADD COLUMN IF NOT EXISTS recovery_days_added  INTEGER NOT NULL DEFAULT 0;

-- 2b. Migrate existing data from old columns to new columns
--     so old records still appear correctly in the UI.

-- Map severity_level (1-10) → text severity
UPDATE plant_health_scans
SET severity = CASE
  WHEN severity_level >= 9 THEN 'critical'
  WHEN severity_level >= 7 THEN 'high'
  WHEN severity_level >= 4 THEN 'medium'
  ELSE 'low'
END
WHERE severity IS NULL AND severity_level IS NOT NULL;

-- Default severity for any remaining NULLs
UPDATE plant_health_scans
SET severity = 'low'
WHERE severity IS NULL;

-- Map is_resolved → status
UPDATE plant_health_scans
SET status = CASE
  WHEN is_resolved = true THEN 'resolved'
  ELSE 'active'
END
WHERE status = 'pending';

-- Map issue_category → issue_type
UPDATE plant_health_scans
SET issue_type = issue_category
WHERE issue_type IS NULL AND issue_category IS NOT NULL;

-- Map detected_species → plant_name
UPDATE plant_health_scans
SET plant_name = detected_species
WHERE plant_name IS NULL AND detected_species IS NOT NULL;

-- Map created_at date → scan_date
UPDATE plant_health_scans
SET scan_date = created_at::DATE
WHERE scan_date IS NULL AND created_at IS NOT NULL;

-- 2c. Link plant_id via garden_plants_spatial where possible
UPDATE plant_health_scans s
SET plant_id = gps.plant_id
FROM garden_plants_spatial gps
WHERE s.plant_id IS NULL
  AND s.spatial_id = gps.id
  AND gps.plant_id IS NOT NULL;

-- 2d. Comments
COMMENT ON COLUMN plant_health_scans.severity IS
  'Text severity level: low | medium | high | critical. Replaces old numeric severity_level.';
COMMENT ON COLUMN plant_health_scans.status IS
  'Lifecycle state: pending | active | resolved. Replaces old boolean is_resolved.';
COMMENT ON COLUMN plant_health_scans.recovery_days_added IS
  'Days added to the linked plant''s recovery_days when this scan is resolved (Feedback Loop). Default: 5.';
COMMENT ON COLUMN plant_health_scans.scan_date IS
  'Date the observation was made. Separate from created_at (system timestamp).';
-- 2e. Drop obsolete garden_library columns (now safe -- all data migrated above)
--     Drop garden_summary view first since it references pollinator_value,
--     then drop columns, then the view is recreated in Section 7.
DROP VIEW IF EXISTS garden_summary;
DROP VIEW IF EXISTS garden_library_effective_maturity;

ALTER TABLE garden_library
  DROP COLUMN IF EXISTS is_invasive,
  DROP COLUMN IF EXISTS ecoregion_affinity,
  DROP COLUMN IF EXISTS mature_height_inches,
  DROP COLUMN IF EXISTS growth_rate_category,
  DROP COLUMN IF EXISTS pollinator_value;


-- ============================================================
-- SECTION 3: garden_logs
-- Renames: category→activity_type, message→notes,
--          timestamp→log_date
-- Adds:    quantity_gal, plant_id
-- ============================================================

-- 3a. Rename category → activity_type
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_logs' AND column_name='category'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_logs' AND column_name='activity_type'
  ) THEN
    ALTER TABLE garden_logs RENAME COLUMN category TO activity_type;
  END IF;
END $$;

-- 3b. Rename message → notes
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_logs' AND column_name='message'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='garden_logs' AND column_name='notes'
  ) THEN
    ALTER TABLE garden_logs RENAME COLUMN message TO notes;
  END IF;
END $$;

-- 3c. Add log_date (date-only companion to timestamp)
ALTER TABLE garden_logs
  ADD COLUMN IF NOT EXISTS log_date      DATE,
  ADD COLUMN IF NOT EXISTS quantity_gal  DECIMAL(6,2),
  ADD COLUMN IF NOT EXISTS plant_id      UUID REFERENCES garden_library(id) ON DELETE SET NULL;

-- 3d. Backfill log_date from timestamp
UPDATE garden_logs
SET log_date = timestamp::DATE
WHERE log_date IS NULL AND timestamp IS NOT NULL;

-- 3e. Backfill log_date for rows with no timestamp
UPDATE garden_logs
SET log_date = CURRENT_DATE
WHERE log_date IS NULL;

-- 3f. Comments
COMMENT ON COLUMN garden_logs.activity_type IS
  'Type of activity: watering | fertilizing | pruning | observation | harvest | planting | other';
COMMENT ON COLUMN garden_logs.log_date IS
  'Date of the activity. Date-only companion to the timestamp column.';
COMMENT ON COLUMN garden_logs.quantity_gal IS
  'Water quantity in gallons (for watering activity type). Used in Water Pulse KPI.';


-- ============================================================
-- SECTION 4: weather_logs (new table — did not exist in v10.5)
-- Populated by the Climate Engine on each weather fetch.
-- ============================================================

CREATE TABLE IF NOT EXISTS weather_logs (
  id              UUID      DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id         UUID      REFERENCES auth.users(id) DEFAULT auth.uid(),
  log_date        DATE      NOT NULL DEFAULT CURRENT_DATE,
  temp_high_f     DECIMAL(5,1),
  temp_low_f      DECIMAL(5,1),
  temp_current_f  DECIMAL(5,1),
  feels_like_f    DECIMAL(5,1),
  solar_hours     DECIMAL(4,1),
  humidity_pct    INTEGER,
  wind_mph        DECIMAL(5,1),
  precipitation_in DECIMAL(5,2),
  weathercode     INTEGER,
  risk_level      TEXT      CHECK (risk_level IN ('LOW','MODERATE','FROST','HEAT')),
  created_at      TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),

  CONSTRAINT weather_logs_user_date_unique UNIQUE (user_id, log_date)
);

ALTER TABLE weather_logs ENABLE ROW LEVEL SECURITY;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE tablename = 'weather_logs'
      AND policyname = 'Users manage own weather_logs'
  ) THEN
    CREATE POLICY "Users manage own weather_logs"
      ON weather_logs FOR ALL USING (auth.uid() = user_id);
  END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_weather_logs_user_date
  ON weather_logs (user_id, log_date DESC);

COMMENT ON TABLE weather_logs IS
  'Daily weather snapshots for Fairfield CT fetched from Open-Meteo API by the Climate Engine. One row per user per day (upsert on log_date).';


-- ============================================================
-- SECTION 5: RLS policies for new/renamed columns
-- ============================================================

-- Ensure RLS is still enabled on all tables
ALTER TABLE garden_library        ENABLE ROW LEVEL SECURITY;
ALTER TABLE plant_health_scans    ENABLE ROW LEVEL SECURITY;
ALTER TABLE garden_logs           ENABLE ROW LEVEL SECURITY;

-- Add policies only if they don't exist
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies
    WHERE tablename='garden_logs' AND policyname='Users manage own logs'
  ) THEN
    CREATE POLICY "Users manage own logs"
      ON garden_logs FOR ALL USING (auth.uid() = user_id);
  END IF;
END $$;


-- ============================================================
-- SECTION 6: Indexes for performance
-- ============================================================

CREATE INDEX IF NOT EXISTS idx_garden_library_user_id
  ON garden_library (user_id);

CREATE INDEX IF NOT EXISTS idx_garden_library_recovery_days
  ON garden_library (recovery_days DESC);

CREATE INDEX IF NOT EXISTS idx_garden_library_planted_date
  ON garden_library (planted_date);

CREATE INDEX IF NOT EXISTS idx_plant_health_scans_user_status
  ON plant_health_scans (user_id, status);

CREATE INDEX IF NOT EXISTS idx_plant_health_scans_scan_date
  ON plant_health_scans (scan_date DESC);

CREATE INDEX IF NOT EXISTS idx_garden_logs_user_date
  ON garden_logs (user_id, log_date DESC);

CREATE INDEX IF NOT EXISTS idx_garden_logs_activity_type
  ON garden_logs (activity_type);


-- ============================================================
-- SECTION 7: Updated garden_summary view
-- Replaces the v10.5 version with v10.6 column names
-- ============================================================

CREATE OR REPLACE VIEW garden_summary AS
SELECT
  u.id AS user_id,

  -- Library stats
  (SELECT count(*)
   FROM garden_library g
   WHERE g.user_id = u.id)                                          AS total_plants,

  (SELECT count(*)
   FROM garden_library g
   WHERE g.user_id = u.id AND g.is_native = true)                  AS native_count,

  (SELECT count(*)
   FROM garden_library g
   WHERE g.user_id = u.id AND g.is_host_plant = true)              AS host_plant_count,

  -- Avg maturity % (effective = maturity_days + recovery_days)
  (SELECT ROUND(AVG(
     LEAST(100,
       ROUND(
         (EXTRACT(EPOCH FROM (NOW() - (g.planted_date::TIMESTAMP))) / 86400.0)
         / NULLIF(g.maturity_days + g.recovery_days, 0) * 100
       )
     )
   ))
   FROM garden_library g
   WHERE g.user_id = u.id
     AND g.planted_date IS NOT NULL
     AND g.maturity_days IS NOT NULL)                              AS avg_maturity_pct,

  -- Total recovery penalty days accumulated
  (SELECT COALESCE(SUM(g.recovery_days), 0)
   FROM garden_library g
   WHERE g.user_id = u.id)                                         AS total_recovery_days,

  -- Pollinator IQ (native×1.5 + host) / total × 50, capped 100
  (SELECT LEAST(100, ROUND(
     (COUNT(*) FILTER (WHERE g.is_native) * 1.5 +
      COUNT(*) FILTER (WHERE g.is_host_plant))
     / NULLIF(COUNT(*), 0) * 50
   ))
   FROM garden_library g
   WHERE g.user_id = u.id)                                         AS pollinator_iq,

  -- Active health issues (high or critical, not resolved)
  (SELECT count(*)
   FROM plant_health_scans s
   WHERE s.user_id = u.id
     AND s.status != 'resolved'
     AND s.severity IN ('high','critical'))                        AS critical_issues_count,

  -- Most recent issue type
  (SELECT s.issue_type
   FROM plant_health_scans s
   WHERE s.user_id = u.id
   ORDER BY s.scan_date DESC NULLS LAST
   LIMIT 1)                                                        AS last_diagnostic_event,

  -- Recent activity (last 7 days)
  (SELECT count(*)
   FROM garden_logs l
   WHERE l.user_id = u.id
     AND l.log_date >= CURRENT_DATE - INTERVAL '7 days')          AS activities_last_7d,

  -- Water this week (gallons)
  (SELECT COALESCE(SUM(l.quantity_gal), 0)
   FROM garden_logs l
   WHERE l.user_id = u.id
     AND l.activity_type IN ('watering','water')
     AND l.log_date >= CURRENT_DATE - INTERVAL '7 days')          AS water_gal_last_7d

FROM auth.users u;

COMMENT ON VIEW garden_summary IS
  'Per-user garden KPI summary. Aggregates library, clinic, and log data for the dashboard.';


-- ============================================================
-- SECTION 8: Effective maturity view (updated)
-- ============================================================

CREATE OR REPLACE VIEW garden_library_effective_maturity AS
SELECT
  id,
  user_id,
  common_name,
  scientific_name,
  emoji,
  plant_family,
  maturity_days,
  recovery_days,
  (maturity_days + recovery_days)                                  AS effective_maturity_days,
  planted_date,
  CASE
    WHEN planted_date IS NOT NULL AND maturity_days IS NOT NULL THEN
      planted_date + (maturity_days + recovery_days) * INTERVAL '1 day'
    ELSE NULL
  END                                                              AS estimated_harvest_date,
  CASE
    WHEN planted_date IS NOT NULL AND maturity_days IS NOT NULL THEN
      LEAST(100, ROUND(
        EXTRACT(EPOCH FROM (NOW() - planted_date::TIMESTAMP)) / 86400.0
        / NULLIF(maturity_days + recovery_days, 0) * 100
      ))
    ELSE NULL
  END                                                              AS maturity_pct,
  is_native,
  is_host_plant
FROM garden_library;

COMMENT ON VIEW garden_library_effective_maturity IS
  'Plant maturity calculations including recovery penalty. Used by dashboard Biological Pulse and calendar harvest windows.';


-- ============================================================
-- SECTION 9: Verification queries
-- Run these after applying the migration to confirm success.
-- ============================================================

-- Check garden_library columns
SELECT
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name   = 'garden_library'
ORDER BY ordinal_position;

-- Check plant_health_scans new columns exist
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name   = 'plant_health_scans'
  AND column_name IN ('severity','status','scan_date','recovery_days_added','plant_name','issue_type')
ORDER BY column_name;

-- Check weather_logs was created
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name   = 'weather_logs'
ORDER BY ordinal_position;

-- Check garden_logs new columns
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name   = 'garden_logs'
  AND column_name IN ('activity_type','notes','log_date','quantity_gal')
ORDER BY column_name;

-- Spot-check data migration (severity backfill)
SELECT
  severity_level,
  severity,
  status,
  issue_type,
  scan_date,
  count(*) AS rows
FROM plant_health_scans
GROUP BY severity_level, severity, status, issue_type, scan_date
ORDER BY severity_level DESC NULLS LAST
LIMIT 20;

-- Summary view smoke test
SELECT * FROM garden_summary LIMIT 5;
