<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Studio | GardenHub OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; color: white; }
        
        /* The Spatial Engine */
        #viewport { 
            background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); 
            background-size: 40px 40px; /* 1 foot = 40px */
            background-color: #0f172a;
            position: relative;
            cursor: crosshair;
            transition: transform 0.3s ease;
        }

        .bed-obj { 
            position: absolute; 
            cursor: move; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            transition: outline 0.2s, transform 0.1s;
        }
        .bed-obj:hover { outline: 2px solid #22c55e; }
        .bed-obj:active { transform: scale(0.98); }

        /* Bed Types */
        .type-raised { background: #92400e; border: 2px solid #78350f; color: #fef3c7; }
        .type-inground { background: #065f46; border: 2px solid #064e3b; color: #d1fae5; }
        .type-wall { background: #475569; border: 2px solid #334155; color: #f1f5f9; }
        .type-canopy { background: rgba(34, 197, 94, 0.1); border: 2px dashed #22c55e; color: #22c55e; border-radius: 50%; }

        /* UI Elements */
        .sidebar-card { 
            background: rgba(30, 41, 59, 0.7); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 16px; transition: all 0.2s ease; cursor: grab;
        }
        .sidebar-card:hover { border-color: #22c55e; background: rgba(30, 41, 59, 1); }
        
        #trash-can {
            transition: all 0.3s;
        }
        #trash-can.drag-over { background: #ef4444; transform: scale(1.1); color: white; }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-80 bg-slate-900 border-r border-white/10 p-6 flex flex-col z-20">
        <div class="mb-8">
            <a href="index.html" class="text-[10px] font-black text-slate-500 uppercase tracking-widest hover:text-white transition">‚Üê Back to Command Center</a>
            <h2 class="text-xl font-black text-white leading-tight uppercase mt-2">Map Studio<br><span class="text-green-500">v2.7</span></h2>
        </div>

        <div class="space-y-6 overflow-y-auto flex-grow pr-2">
            <section>
                <p class="text-[9px] font-bold text-slate-500 uppercase px-1 mb-3 tracking-widest">Structural Elements</p>
                <div class="space-y-2">
                    <div class="sidebar-card p-4 text-xs font-black uppercase" draggable="true" ondragstart="handleDragStart(event)" data-type="raised" data-w="160" data-h="80">üü´ Raised Bed (4'x2')</div>
                    <div class="sidebar-card p-4 text-xs font-black uppercase" draggable="true" ondragstart="handleDragStart(event)" data-type="inground" data-w="120" data-h="120">üå± In-Ground (3'x3')</div>
                    <div class="sidebar-card p-4 text-xs font-black uppercase" draggable="true" ondragstart="handleDragStart(event)" data-type="wall" data-w="240" data-h="20">üß± Brick Wall (Heat)</div>
                    <div class="sidebar-card p-4 text-xs font-black uppercase" draggable="true" ondragstart="handleDragStart(event)" data-type="canopy" data-w="200" data-h="200">üå≥ Tree Canopy (Shade)</div>
                </div>
            </section>

            <section class="p-4 bg-blue-500/10 border border-blue-500/20 rounded-2xl">
                <p class="text-[9px] font-black text-blue-400 uppercase">Ecoregion Overlay</p>
                <p class="text-[11px] text-blue-100/70 mt-1">Objects placed here interact with <strong>Hartford Ecoregion 59</strong> microclimate physics.</p>
            </section>
        </div>

        <div class="pt-6 border-t border-white/10 space-y-4">
            <div id="trash-can" 
                 onactivate="this.classList.add('drag-over')" 
                 ondragover="event.preventDefault(); this.classList.add('drag-over')" 
                 ondragleave="this.classList.remove('drag-over')"
                 ondrop="handleDeleteDrop(event)"
                 class="w-full py-4 border-2 border-dashed border-slate-700 rounded-2xl text-[10px] font-black uppercase text-slate-500 text-center">
                üóëÔ∏è Drop here to remove
            </div>
            <button onclick="window.print()" class="w-full py-3 bg-white text-slate-900 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-green-400 transition">Export Plot</button>
        </div>
    </aside>

    <main class="flex-grow flex flex-col relative bg-slate-950 overflow-hidden">
        <div class="absolute top-8 left-8 z-10 flex items-center gap-4">
            <div class="bg-slate-900/80 backdrop-blur px-4 py-2 rounded-full border border-white/10 flex items-center gap-3">
                <span class="w-10 h-[2px] bg-green-500"></span>
                <span class="text-[10px] font-black uppercase tracking-widest text-white">Scale: 1 Foot</span>
            </div>
        </div>

        <div id="viewport" class="w-[3000px] h-[3000px]" 
             ondragover="event.preventDefault()" 
             ondrop="handleCanvasDrop(event)">
            <div id="bed-container" class="absolute inset-0"></div>
        </div>
    </main>

<script>
    const SUPABASE_URL = 'https://zrohwzqaksqruywiedxt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyb2h3enFha3NxcnV5d2llZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzUwOTYsImV4cCI6MjA4NzQ1MTA5Nn0.cS8_C2WCdqH-e_ysxooH2wbarlxmi-S6CDZkevg_DPM'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let activeBeds = [];

    async function init() {
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) return;

        // Fetch existing beds from the new garden_beds table
        const { data: beds, error } = await _supabase
            .from('garden_beds')
            .select('*')
            .eq('user_id', user.id);

        if (beds) {
            activeBeds = beds;
            renderBeds();
        }
    }

    // --- DRAG & DROP LOGIC ---

    function handleDragStart(e) {
        // Handle dragging from sidebar
        if (e.target.dataset.type) {
            e.dataTransfer.setData("type", e.target.dataset.type);
            e.dataTransfer.setData("w", e.target.dataset.w);
            e.dataTransfer.setData("h", e.target.dataset.h);
            e.dataTransfer.setData("source", "sidebar");
        } 
        // Handle moving existing beds
        else if (e.target.id.startsWith('bed-')) {
            e.dataTransfer.setData("bedId", e.target.id);
            e.dataTransfer.setData("source", "canvas");
        }
    }

    async function handleCanvasDrop(e) {
        e.preventDefault();
        const rect = document.getElementById('viewport').getBoundingClientRect();
        const source = e.dataTransfer.getData("source");
        const { data: { user } } = await _supabase.auth.getUser();

        if (source === "sidebar") {
            const type = e.dataTransfer.getData("type");
            const w = parseInt(e.dataTransfer.getData("w"));
            const h = parseInt(e.dataTransfer.getData("h"));
            
            // Snap to 10px increments (3 inches)
            const x = Math.round((e.clientX - rect.left - (w/2)) / 10) * 10;
            const y = Math.round((e.clientY - rect.top - (h/2)) / 10) * 10;

            const newBed = {
                user_id: user.id,
                shape_type: type,
                x_pos: x,
                y_pos: y,
                width: w,
                height: h
            };

            const { data, error } = await _supabase.from('garden_beds').insert([newBed]).select();
            if (data) {
                activeBeds.push(data[0]);
                renderBeds();
            }
        } 
        else if (source === "canvas") {
            const bedId = e.dataTransfer.getData("bedId").split('-')[1];
            const bed = activeBeds.find(b => b.id === bedId);
            
            const x = Math.round((e.clientX - rect.left - (bed.width/2)) / 10) * 10;
            const y = Math.round((e.clientY - rect.top - (bed.height/2)) / 10) * 10;

            const { error } = await _supabase
                .from('garden_beds')
                .update({ x_pos: x, y_pos: y })
                .eq('id', bedId);

            if (!error) {
                bed.x_pos = x;
                bed.y_pos = y;
                renderBeds();
            }
        }
    }

    async function handleDeleteDrop(e) {
        e.preventDefault();
        document.getElementById('trash-can').classList.remove('drag-over');
        const source = e.dataTransfer.getData("source");
        
        if (source === "canvas") {
            const bedId = e.dataTransfer.getData("bedId").split('-')[1];
            
            const { error } = await _supabase.from('garden_beds').delete().eq('id', bedId);
            if (!error) {
                activeBeds = activeBeds.filter(b => b.id !== bedId);
                renderBeds();
            }
        }
    }

    // --- RENDERING ---

    function renderBeds() {
        const container = document.getElementById('bed-container');
        container.innerHTML = '';

        activeBeds.forEach(bed => {
            const el = document.createElement('div');
            el.id = `bed-${bed.id}`;
            el.className = `bed-obj type-${bed.shape_type}`;
            el.style.width = `${bed.width}px`;
            el.style.height = `${bed.height}px`;
            el.style.left = `${bed.x_pos}px`;
            el.style.top = `${bed.y_pos}px`;
            el.draggable = true;
            el.innerText = bed.shape_type;
            
            el.ondragstart = handleDragStart;
            container.appendChild(el);
        });
    }

    window.onload = init;
</script>
</body>
</html>
