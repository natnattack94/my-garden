<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Studio | GardenHub OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; color: white; }
        #viewport { 
            background-color: #0f172a; position: relative; width: 1000px; height: 1000px;
            display: grid; grid-template-columns: repeat(20, 50px); grid-template-rows: repeat(20, 50px);
            gap: 2px; padding: 10px;
        }
        .grid-cell {
            width: 50px; height: 50px; background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; z-index: 5;
        }
        .tag-frost { background: rgba(99, 102, 241, 0.4) !important; border-color: #6366f1 !important; }
        .tag-wet { background: rgba(6, 182, 212, 0.4) !important; border-color: #06b6d4 !important; }
        .bed-obj { 
            position: absolute; cursor: move; display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; text-transform: uppercase; border-radius: 8px; z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .type-raised { background: #92400e; border: 2px solid #78350f; color: #fef3c7; }
        .type-inground { background: #065f46; border: 2px solid #064e3b; color: #d1fae5; }
        .type-wall { background: #334155; border: 2px solid #475569; color: #f1f5f9; }
        .plant-obj {
            position: absolute; cursor: pointer; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; border-radius: 50%; z-index: 60; transition: transform 0.2s;
        }
        .plant-halo {
            position: absolute; border-radius: 50%; border: 1px dashed rgba(34, 197, 94, 0.4);
            background: rgba(34, 197, 94, 0.05); pointer-events: none; z-index: 40;
        }
        .sidebar-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
        .active-btn { background: #f59e0b !important; color: #000 !important; }
        .passport-tag-active { background: #3b82f6 !important; color: white !important; border-color: #60a5fa !important; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-80 sidebar-panel border-r border-white/10 p-6 flex flex-col z-[100] overflow-y-auto">
        <div class="mb-6 flex justify-between items-start">
            <div>
                <h2 class="text-[10px] font-black text-green-500 uppercase tracking-widest mb-1">Eco-Intelligence v5.5</h2>
                <p class="text-xl font-black text-white uppercase">Spatial Studio</p>
            </div>
            <div class="text-right">
                <p class="text-[8px] font-bold text-slate-500 uppercase">Opt. Score</p>
                <p id="opt-score" class="text-xl font-black text-green-400">100%</p>
            </div>
        </div>

        <div class="mb-6 p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
            <p class="text-[9px] font-black text-blue-400 uppercase mb-3">Crop Rotation Year</p>
            <div class="flex gap-1">
                <button onclick="setYear(2026)" id="yr-2026" class="yr-btn flex-1 py-1 bg-slate-800 rounded text-[10px] font-black active-btn">2026</button>
                <button onclick="setYear(2027)" id="yr-2027" class="yr-btn flex-1 py-1 bg-slate-800 rounded text-[10px] font-black">2027</button>
            </div>
            <div id="soil-stats" class="mt-4">
                <div class="flex justify-between text-[8px] font-bold text-slate-400 mb-1 uppercase">
                    <span>Nitrogen Level</span> <span id="n-val">Optimal</span>
                </div>
                <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                    <div id="n-bar" class="bg-blue-500 h-full w-[100%] transition-all"></div>
                </div>
            </div>
        </div>

        <div class="mb-6 p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl">
            <p class="text-[9px] font-black text-purple-400 uppercase mb-2">Agronomy Alerts</p>
            <div id="intel-alerts" class="space-y-2 max-h-32 overflow-y-auto text-[8px]">
                <p class="text-slate-500 italic">No spatial risks detected.</p>
            </div>
        </div>

        <div class="space-y-6">
            <div>
                <p class="text-[9px] font-bold text-slate-500 uppercase px-1 mb-3">Structures</p>
                <div class="grid grid-cols-2 gap-2">
                    <div class="p-2 bg-slate-800 rounded-lg text-[8px] font-bold text-center cursor-grab" draggable="true" ondragstart="startBedDrag(event, 'raised', 150, 100)">üü´ Raised Bed</div>
                    <div class="p-2 bg-slate-700 rounded-lg text-[8px] font-bold text-center cursor-grab" draggable="true" ondragstart="startBedDrag(event, 'wall', 200, 20)">üß± Heat-Wall</div>
                </div>
            </div>

            <div>
                <p class="text-[9px] font-bold text-slate-500 uppercase px-1 mb-3">Plant Library</p>
                <div class="grid grid-cols-2 gap-2">
                    <div class="p-2 bg-slate-800 border border-white/5 rounded-lg text-[10px] cursor-grab" draggable="true" ondragstart="startPlantDrag(event, 'Tomato', 'üçÖ', 24, 'Nightshade')">üçÖ Tomato</div>
                    <div class="p-2 bg-slate-800 border border-white/5 rounded-lg text-[10px] cursor-grab" draggable="true" ondragstart="startPlantDrag(event, 'Pea', 'ü´õ', 8, 'Legume')">ü´õ Pea (N-Fix)</div>
                </div>
            </div>
        </div>

        <div class="mt-auto space-y-2">
            <div id="trash-bin" ondragover="event.preventDefault()" ondrop="deleteItem(event)" class="py-3 border-2 border-dashed border-slate-800 rounded-xl text-[8px] font-bold text-slate-600 text-center uppercase">üóëÔ∏è Trash</div>
            <button onclick="saveLayout()" class="w-full py-3 bg-white text-slate-900 rounded-xl text-[9px] font-black uppercase tracking-widest">Sync DNA</button>
        </div>
    </aside>

    <main class="flex-grow overflow-auto bg-slate-950 p-20 flex items-center justify-center relative">
        <div id="viewport" ondragover="event.preventDefault()" ondrop="handleDrop(event)"></div>

        <div id="passport-modal" class="hidden absolute top-10 right-10 w-72 bg-slate-900/95 border border-white/20 rounded-2xl shadow-2xl z-[200] p-5 backdrop-blur-xl">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="pass-emoji" class="text-3xl mb-1">üçÖ</h3>
                    <h2 id="pass-title" class="text-lg font-black uppercase tracking-tighter leading-none">Plant Passport</h2>
                </div>
                <button onclick="closePassport()" class="text-slate-500 hover:text-white">‚úï</button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-[7px] font-black text-slate-500 uppercase">Cultivar / Seed Source</label>
                    <input id="pass-variety" type="text" placeholder="e.g. Sungold / Baker Creek" class="w-full bg-slate-800 border-none rounded p-2 text-[10px] mt-1 text-white">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[7px] font-black text-slate-500 uppercase">Date Planted</label>
                        <input id="pass-date" type="date" class="w-full bg-slate-800 border-none rounded p-2 text-[9px] mt-1 text-white">
                    </div>
                    <div>
                        <label class="text-[7px] font-black text-slate-500 uppercase">Germination %</label>
                        <input id="pass-germ" type="number" class="w-full bg-slate-800 border-none rounded p-2 text-[10px] mt-1 text-white">
                    </div>
                </div>
                <div class="flex gap-1 py-1">
                    <button id="tag-overwinter" onclick="togglePassTag('overwinter')" class="flex-1 py-1 border border-white/10 rounded text-[7px] font-bold uppercase">‚ùÑÔ∏è Overwinter</button>
                    <button id="tag-selfseed" onclick="togglePassTag('selfseed')" class="flex-1 py-1 border border-white/10 rounded text-[7px] font-bold uppercase">üå± Self-Seed</button>
                </div>
                <div>
                    <label class="text-[7px] font-black text-slate-500 uppercase">Notes</label>
                    <textarea id="pass-notes" rows="2" class="w-full bg-slate-800 border-none rounded p-2 text-[10px] mt-1 text-white"></textarea>
                </div>
                <button onclick="savePassportData()" class="w-full py-2 bg-green-600 rounded-lg text-[9px] font-black uppercase tracking-widest">Update Passport</button>
            </div>
        </div>
    </main>

<script>
    const _supabase = supabase.createClient('https://zrohwzqaksqruywiedxt.supabase.co', 'YOUR_KEY_HERE');

    let bedData = [];
    let plantData = []; 
    let yearArchive = { 2025: [], 2026: [], 2027: [] };
    let currentYear = 2026;
    let activePassportId = null;

    const RELATIONS = [
        { a: 'Tomato', b: 'Fennel', type: 'conflict', reason: 'Fennel inhibits tomato growth.' },
        { a: 'Tomato', b: 'Basil', type: 'synergy', reason: 'Basil repels hornworms.' }
    ];

    function createGrid() {
        const vp = document.getElementById('viewport');
        for (let i = 0; i < 400; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = `cell-${i}`;
            vp.appendChild(cell);
        }
    }

    // --- DRAG/DROP ---
    function startBedDrag(e, type, w, h) {
        e.dataTransfer.setData("itemType", "bed"); e.dataTransfer.setData("type", type);
        e.dataTransfer.setData("w", w); e.dataTransfer.setData("h", h); e.dataTransfer.setData("isNew", "true");
    }

    function startPlantDrag(e, name, icon, spread, family) {
        e.dataTransfer.setData("itemType", "plant"); e.dataTransfer.setData("name", name);
        e.dataTransfer.setData("icon", icon); e.dataTransfer.setData("spread", spread);
        e.dataTransfer.setData("family", family); e.dataTransfer.setData("isNew", "true");
    }

    function handleDrop(e) {
        const rect = document.getElementById('viewport').getBoundingClientRect();
        const x = e.clientX - rect.left; const y = e.clientY - rect.top;
        const itemType = e.dataTransfer.getData("itemType");
        const isNew = e.dataTransfer.getData("isNew") === "true";

        if (itemType === "bed") {
            if (isNew) {
                const w = parseInt(e.dataTransfer.getData("w")), h = parseInt(e.dataTransfer.getData("h"));
                bedData.push({ id: Date.now(), type: e.dataTransfer.getData("type"), x: x-(w/2), y: y-(h/2), w, h });
            } else {
                const id = parseInt(e.dataTransfer.getData("id")), bed = bedData.find(b => b.id === id);
                if (bed) { bed.x = x-(bed.w/2); bed.y = y-(bed.h/2); }
            }
        } else if (itemType === "plant") {
            if (isNew) {
                plantData.push({ 
                    id: Date.now(), name: e.dataTransfer.getData("name"), icon: e.dataTransfer.getData("icon"), 
                    spread: parseInt(e.dataTransfer.getData("spread")), family: e.dataTransfer.getData("family"), 
                    x, y, passport: { variety: '', date: '', germ: '', notes: '', overwinter: false, selfseed: false }
                });
            } else {
                const id = parseInt(e.dataTransfer.getData("id")), plant = plantData.find(p => p.id === id);
                if (plant) { plant.x = x; plant.y = y; }
            }
        }
        renderAll();
    }

    // --- PASSPORT LOGIC ---
    function openPassport(id) {
        const plant = plantData.find(p => p.id === id);
        if (!plant) return;
        activePassportId = id;
        document.getElementById('passport-modal').classList.remove('hidden');
        document.getElementById('pass-emoji').innerText = plant.icon;
        document.getElementById('pass-title').innerText = plant.name;
        
        // Load data
        document.getElementById('pass-variety').value = plant.passport.variety;
        document.getElementById('pass-date').value = plant.passport.date;
        document.getElementById('pass-germ').value = plant.passport.germ;
        document.getElementById('pass-notes').value = plant.passport.notes;
        
        updatePassTagUI('overwinter', plant.passport.overwinter);
        updatePassTagUI('selfseed', plant.passport.selfseed);
    }

    function togglePassTag(tag) {
        const plant = plantData.find(p => p.id === activePassportId);
        plant.passport[tag] = !plant.passport[tag];
        updatePassTagUI(tag, plant.passport[tag]);
    }

    function updatePassTagUI(tag, active) {
        document.getElementById(`tag-${tag}`).classList.toggle('passport-tag-active', active);
    }

    function savePassportData() {
        const plant = plantData.find(p => p.id === activePassportId);
        plant.passport.variety = document.getElementById('pass-variety').value;
        plant.passport.date = document.getElementById('pass-date').value;
        plant.passport.germ = document.getElementById('pass-germ').value;
        plant.passport.notes = document.getElementById('pass-notes').value;
        closePassport();
    }

    function closePassport() { document.getElementById('passport-modal').classList.add('hidden'); activePassportId = null; }

    // --- ENGINE ---
    function renderAll() {
        document.querySelectorAll('.bed-obj, .plant-obj, .plant-halo').forEach(el => el.remove());
        const vp = document.getElementById('viewport');

        bedData.forEach(bed => {
            const el = document.createElement('div');
            el.className = `bed-obj type-${bed.type}`;
            el.style.left = `${bed.x}px`; el.style.top = `${bed.y}px`;
            el.style.width = `${bed.w}px`; el.style.height = `${bed.h}px`;
            el.innerText = bed.type; el.draggable = true;
            el.ondragstart = (e) => { e.dataTransfer.setData("itemType", "bed"); e.dataTransfer.setData("id", bed.id); e.dataTransfer.setData("isNew", "false"); };
            vp.appendChild(el);
        });

        plantData.forEach(plant => {
            const matureSize = (plant.spread / 12) * 50;
            const halo = document.createElement('div');
            halo.className = 'plant-halo';
            halo.style.width = `${matureSize}px`; halo.style.height = `${matureSize}px`;
            halo.style.left = `${plant.x - (matureSize/2)}px`; halo.style.top = `${plant.y - (matureSize/2)}px`;
            vp.appendChild(halo);

            const el = document.createElement('div');
            el.className = 'plant-obj';
            el.style.left = `${plant.x - 20}px`; el.style.top = `${plant.y - 20}px`;
            el.innerText = plant.icon; el.draggable = true;
            el.onclick = () => openPassport(plant.id);
            el.ondragstart = (e) => { e.dataTransfer.setData("itemType", "plant"); e.dataTransfer.setData("id", plant.id); e.dataTransfer.setData("isNew", "false"); };
            vp.appendChild(el);
        });

        runAgronomyIntel();
    }

    function runAgronomyIntel() {
        const container = document.getElementById('intel-alerts');
        container.innerHTML = '';
        let alerts = [], nitrogen = 100, score = 100;

        plantData.forEach((p1, i) => {
            if (p1.family === 'Nightshade') nitrogen -= 10;
            if (p1.family === 'Legume') nitrogen += 15;

            // Rotation Check
            const prevYear = yearArchive[currentYear - 1] || [];
            prevYear.forEach(prevP => {
                if (Math.hypot(p1.x - prevP.x, p1.y - prevP.y) < 80 && p1.family === prevP.family) {
                    alerts.push(`‚ö†Ô∏è Rotation Conflict: ${p1.name} on ${prevP.family} soil.`);
                    score -= 15;
                }
            });
        });

        if (alerts.length === 0) container.innerHTML = '<p class="text-slate-500 italic">No spatial risks detected.</p>';
        alerts.forEach(a => container.innerHTML += `<div class="p-2 border border-white/10 rounded bg-slate-900/50">${a}</div>`);
        
        document.getElementById('n-bar').style.width = `${Math.min(nitrogen, 100)}%`;
        document.getElementById('opt-score').innerText = `${Math.max(0, score)}%`;
    }

    function setYear(yr) {
        yearArchive[currentYear] = JSON.parse(JSON.stringify(plantData));
        currentYear = yr;
        plantData = yearArchive[yr] || [];
        document.querySelectorAll('.yr-btn').forEach(b => b.classList.toggle('active-btn', b.id === `yr-${yr}`));
        renderAll();
    }

    function deleteItem(e) {
        const id = parseInt(e.dataTransfer.getData("id")), type = e.dataTransfer.getData("itemType");
        if (type === "bed") bedData = bedData.filter(b => b.id !== id);
        else plantData = plantData.filter(p => p.id !== id);
        renderAll();
    }

    window.onload = () => { createGrid(); renderAll(); };
</script>
</body>
</html>
