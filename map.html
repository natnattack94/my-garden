<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9x9 Precision Grid | GardenHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --leaf: #4f772d; --dark: #31572c; --dirt: #604d3f; 
            --grass: #aacc00; --wood: #bc8a5f; --seed: #e9c46a;
            --friend-glow: #4ade80;
            --foe-glow: #f87171;
        }
        
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        #sidebar {
            width: 280px; background: white; padding: 24px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            z-index: 100; border-right: 1px solid #e2e8f0;
        }
        
        /* Updated Sidebar Card Style */
        .seed-card {
            background: white; padding: 12px; border-radius: 12px;
            margin-bottom: 10px; cursor: grab; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #e2e8f0; transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .seed-card:active { cursor: grabbing; scale: 0.95; }
        .seed-card:hover { border-color: #22c55e; transform: translateX(5px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .qty-tag { font-size: 0.65rem; background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; }

        .main-view { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* Glass Style Grid Container */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(9, 60px); 
            grid-template-rows: repeat(9, 60px);    
            gap: 4px;
            background: #ffffff;
            padding: 16px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .grid-spot {
            width: 60px; height: 60px;
            background: #f8fafc;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
            border-radius: 8px; position: relative;
            overflow: hidden; border: 1px solid #f1f5f9;
        }

        .grid-spot.occupied { background: #ecfdf5; border-color: #10b981; }
        
        .ghost-friend { background-color: #dcfce7 !important; outline: 3px solid var(--friend-glow); outline-offset: -3px; }
        .ghost-foe { background-color: #fee2e2 !important; outline: 3px solid var(--foe-glow); outline-offset: -3px; }

        .grid-spot * { pointer-events: none; }
        .grid-spot:not(.dragging-over) .photo-upload-btn { pointer-events: auto; }

        .photo-upload-btn {
            position: absolute; top: 2px; left: 2px;
            background: white; border-radius: 4px;
            width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; z-index: 20; opacity: 0; transition: 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .grid-spot.occupied:hover .photo-upload-btn { opacity: 1; }
        
        .growth-snapshot { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; z-index: 1; }
        .plant-emoji { position: relative; z-index: 2; font-size: 1.8rem; }
        .multiplier-badge { position: absolute; bottom: 2px; right: 2px; background: #10b981; color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; font-weight: bold; z-index: 3; }

        .grid-spot.occupied:hover::after {
            content: "‚úï"; position: absolute; font-size: 1.2rem; color: white;
            background: rgba(239, 68, 68, 0.8); width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; z-index: 30;
        }

        .btn-clear { background: #f8fafc; color: #ef4444; border: 1px solid #fee2e2; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: auto; transition: 0.2s; }
        .btn-clear:hover { background: #fee2e2; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Crop Command</h3>
    
    <div id="library-drag-container">
        </div>

    <button class="btn-clear" onclick="clearFullGrid()">Reset Grid</button>
    <a href="index.html" class="block text-center mt-4 text-xs font-bold text-slate-500 hover:text-green-600 transition">‚Üê Dashboard</a>
</div>

<div class="main-view">
    <div class="text-center mb-6">
        <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tighter">9x9 Precision Grid</h2>
        <p id="feedback-text" class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Zone 6B Companion Mapping</p>
    </div>
    <div class="grid-container" id="gardenGrid"></div>
</div>

<script>
    const GRID_SIZE = 81; 
    const COLS = 9;
    const gridContainer = document.getElementById('gardenGrid');

    // Default logic for companion planting
    const plantLogic = {
        "Tomato": { friends: ["Basil", "Carrot", "Lettuce"], foes: ["Broccoli"] },
        "Basil": { friends: ["Tomato"], foes: [] },
        "Lettuce": { friends: ["Carrot", "Tomato", "Broccoli"], foes: [] },
        "Carrot": { friends: ["Tomato", "Lettuce"], foes: [] },
        "Broccoli": { friends: ["Lettuce"], foes: ["Tomato"] },
        "Cosmos": { friends: ["Tomato"], foes: [] }
    };

    function loadLibrarySidebar() {
        const library = JSON.parse(localStorage.getItem('myGardenLibrary')) || [
            { name: "Cosmos", emoji: "üå∏", type: "Flower" },
            { name: "Tomato", emoji: "üçÖ", type: "Vegetable" }
        ];
        
        const container = document.getElementById('library-drag-container');
        container.innerHTML = library.map(p => `
            <div class="seed-card" draggable="true" ondragstart="drag(event)" 
                 data-emoji="${p.emoji}" data-name="${p.name}" data-qty="1">
                <span>${p.emoji} ${p.name}</span> 
                <span class="qty-tag">${p.type}</span>
            </div>
        `).join('');
    }

    function initGrid() {
        const savedLayout = JSON.parse(localStorage.getItem('gardenGridLayout')) || {};
        gridContainer.innerHTML = ""; 
        
        for (let i = 0; i < GRID_SIZE; i++) {
            const spot = document.createElement('div');
            spot.classList.add('grid-spot');
            spot.id = `spot-${i}`;
            
            spot.addEventListener('dragover', (e) => handleDragOver(e, i));
            spot.addEventListener('dragleave', (e) => clearGlow(e.currentTarget));
            spot.addEventListener('drop', (e) => handleDrop(e, i));
            spot.onclick = () => removePlant(i);
            
            if (savedLayout[i]) {
                const data = savedLayout[i];
                if (data.photo) {
                    const img = document.createElement('img');
                    img.src = data.photo;
                    img.className = 'growth-snapshot';
                    spot.appendChild(img);
                }
                const emojiSpan = document.createElement('span');
                emojiSpan.className = 'plant-emoji';
                emojiSpan.innerText = data.emoji;
                spot.appendChild(emojiSpan);

                const upBtn = document.createElement('div');
                upBtn.className = 'photo-upload-btn';
                upBtn.innerHTML = 'üì∑';
                upBtn.onclick = (e) => { e.stopPropagation(); triggerUpload(i); };
                spot.appendChild(upBtn);

                spot.classList.add('occupied');
            }
            gridContainer.appendChild(spot);
        }
    }

    let draggedPlantName = "";
    function drag(ev) {
        draggedPlantName = ev.target.getAttribute('data-name');
        ev.dataTransfer.setData("emoji", ev.target.getAttribute('data-emoji'));
        ev.dataTransfer.setData("name", draggedPlantName);
    }

    function handleDragOver(ev, index) {
        ev.preventDefault();
        const spot = ev.currentTarget;
        if (spot.classList.contains('occupied')) return;
        
        spot.classList.add('dragging-over');
        const status = checkCompanions(index, draggedPlantName);
        
        if (status === 'friend') spot.classList.add('ghost-friend');
        else if (status === 'foe') spot.classList.add('ghost-foe');
    }

    function clearGlow(element) {
        element.classList.remove('ghost-friend', 'ghost-foe', 'dragging-over');
    }

    function checkCompanions(index, newPlant) {
        const row = Math.floor(index / COLS);
        const col = index % COLS;
        const savedLayout = JSON.parse(localStorage.getItem('gardenGridLayout')) || {};
        let status = 'neutral';

        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                if (i === 0 && j === 0) continue;
                const nRow = row + i, nCol = col + j;
                if (nRow >= 0 && nRow < COLS && nCol >= 0 && nCol < COLS) {
                    const neighbor = savedLayout[nRow * COLS + nCol];
                    if (neighbor && plantLogic[newPlant]) {
                        if (plantLogic[newPlant].foes.includes(neighbor.name)) return 'foe';
                        if (plantLogic[newPlant].friends.includes(neighbor.name)) status = 'friend';
                    }
                }
            }
        }
        return status;
    }

    function handleDrop(ev, index) {
        ev.preventDefault();
        const emoji = ev.dataTransfer.getData("emoji");
        const name = ev.dataTransfer.getData("name");
        if(!emoji) return;
        
        let savedLayout = JSON.parse(localStorage.getItem('gardenGridLayout')) || {};
        savedLayout[index] = { emoji, name };
        localStorage.setItem('gardenGridLayout', JSON.stringify(savedLayout));
        clearGlow(ev.currentTarget);
        initGrid(); 
    }

    function removePlant(index) {
        let savedLayout = JSON.parse(localStorage.getItem('gardenGridLayout')) || {};
        if (savedLayout[index]) {
            delete savedLayout[index];
            localStorage.setItem('gardenGridLayout', JSON.stringify(savedLayout));
            initGrid(); 
        }
    }

    function clearFullGrid() {
        if (confirm("Clear the entire map?")) {
            localStorage.removeItem('gardenGridLayout');
            initGrid();
        }
    }

    window.onload = () => {
        loadLibrarySidebar();
        initGrid();
    };
</script>
</body>
</html>
