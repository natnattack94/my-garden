<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GardenHub OS | Spatial Studio v10.5 (Full Feature)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; color: white; }
        
        /* Grid System */
        #viewport { 
            background-color: #0f172a; position: relative; width: 1000px; height: 1000px;
            display: grid; grid-template-columns: repeat(20, 50px); grid-template-rows: repeat(20, 50px);
            gap: 2px; padding: 10px; border: 2px solid rgba(255,255,255,0.05);
        }
        .grid-cell { position: relative; width: 50px; height: 50px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s ease; cursor: crosshair; }
        .grid-cell:hover { background: rgba(255,255,255,0.08); }
        
        /* Pathogen & Soil Layers */
        .tag-frost { background: rgba(99, 102, 241, 0.4) !important; border-color: #6366f1 !important; }
        .tag-wet { background: rgba(6, 182, 212, 0.4) !important; border-color: #06b6d4 !important; }
        .tag-pest { background: rgba(239, 68, 68, 0.4) !important; border-color: #ef4444 !important; }
        .tag-yield { background: rgba(234, 179, 8, 0.4) !important; border-color: #eab308 !important; }
        
        .pathogen-high { background: rgba(239, 68, 68, 0.5) !important; animation: pulse-red 2s infinite; border: 1px solid #ef4444; }
        .vulnerability-warning { border: 2px dashed rgba(239, 68, 68, 0.6) !important; }
        .soil-depleted { background: rgba(146, 64, 14, 0.4) !important; border: 1px solid #92400e; }

        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Objects */
        .bed-obj { position: absolute; cursor: move; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 900; text-transform: uppercase; border-radius: 8px; z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .type-raised { background: #92400e; border: 2px solid #78350f; color: #fef3c7; }
        .type-wall { background: #334155; border: 2px solid #475569; color: #f1f5f9; }
        .plant-obj { position: absolute; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 22px; border-radius: 50%; z-index: 60; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .stage-bloom { box-shadow: 0 0 15px #ec4899; border: 2px solid #ec4899; }

        .glass-panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; }
        .active-btn { background: #3b82f6 !important; color: white !important; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-[360px] bg-slate-900/90 backdrop-blur-xl border-r border-white/10 p-6 flex flex-col gap-5 overflow-y-auto z-[100]">
        <div>
            <h2 class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Temporal IQ v10.5</h2>
            <p class="text-2xl font-black text-white uppercase tracking-tighter leading-none">Spatial Studio</p>
        </div>

        <div class="glass-panel p-4">
            <h3 class="text-[9px] font-bold text-slate-400 uppercase mb-3">Crop Rotation & Soil</h3>
            <div class="flex gap-2 mb-3">
                <button id="rot-2026" onclick="setRotationYear(2026)" class="flex-1 py-1 bg-amber-600 text-white rounded-lg text-[10px] font-black border border-amber-600/30">2026</button>
                <button id="rot-2027" onclick="setRotationYear(2027)" class="flex-1 py-1 bg-white/5 text-slate-500 rounded-lg text-[10px] font-black border border-white/5">2027</button>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-300">NITROGEN HEALTH</span>
                <span id="nitrogen-stat" class="text-[10px] font-black text-green-400 uppercase tracking-widest">Optimal</span>
            </div>
        </div>

        <div id="active-alert-panel" class="hidden glass-panel p-4 border-l-4 border-red-500 bg-red-500/10">
            <h3 class="text-[9px] font-black text-red-400 uppercase mb-1">Tactical Alert</h3>
            <p id="alert-text" class="text-[10px] font-bold text-white"></p>
        </div>

        <div class="glass-panel p-4 border-l-4 border-emerald-500">
            <h3 class="text-[9px] font-bold text-emerald-400 uppercase mb-2">Memory Insights</h3>
            <div id="insights-list" class="space-y-2 text-[10px]"></div>
        </div>

        <div class="glass-panel p-4">
            <h3 class="text-[9px] font-bold text-slate-400 uppercase mb-3">Map Vision Layers</h3>
            <div class="space-y-2">
                <label class="flex items-center justify-between cursor-pointer p-2 bg-white/5 rounded-lg border border-white/5 hover:border-white/20 transition">
                    <span class="text-[10px] font-bold text-slate-300 uppercase">Pathogen Heatmap</span>
                    <input type="checkbox" id="heatmap-toggle" onchange="toggleHeatmap(this.checked)" class="w-4 h-4 accent-red-500">
                </label>
                <label class="flex items-center justify-between cursor-pointer p-2 bg-white/5 rounded-lg border border-white/5 hover:border-white/20 transition">
                    <span class="text-[10px] font-bold text-slate-300 uppercase">Soil Nutrient Map</span>
                    <input type="checkbox" id="soil-toggle" onchange="toggleSoilMap(this.checked)" class="w-4 h-4 accent-emerald-500">
                </label>
            </div>
        </div>

        <div class="glass-panel p-4">
            <h3 class="text-[9px] font-bold text-slate-400 uppercase mb-3">Inventory</h3>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <div class="p-3 bg-white/5 border border-white/10 rounded-xl cursor-grab text-[10px] font-bold" draggable="true" ondragstart="startBedDrag(event, 'raised', 150, 100)">üü´ Raised Bed</div>
                <div class="p-3 bg-white/5 border border-white/10 rounded-xl cursor-grab text-[10px] font-bold" draggable="true" ondragstart="startBedDrag(event, 'wall', 200, 20)">üß± Heat-Wall</div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="p-3 bg-white/5 border border-white/10 rounded-xl cursor-grab text-[10px] font-bold" draggable="true" ondragstart="startPlantDrag(event, 'Tomato', 'üçÖ', 24, 75, 140)">üçÖ Tomato</div>
                <div class="p-3 bg-white/5 border border-white/10 rounded-xl cursor-grab text-[10px] font-bold" draggable="true" ondragstart="startPlantDrag(event, 'Zinnia', 'üå∏', 12, 60, 130)">üå∏ Zinnia</div>
            </div>
        </div>

        <div class="mt-auto border-t border-white/10 pt-4">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setTacticalMode('frost')" id="btn-frost" class="py-2.5 bg-slate-800 border border-white/10 rounded-xl text-[9px] font-black uppercase">‚ùÑÔ∏è Frost</button>
                <button onclick="setTacticalMode('wet')" id="btn-wet" class="py-2.5 bg-slate-800 border border-white/10 rounded-xl text-[9px] font-black uppercase">üíß Wet</button>
                <button onclick="setTacticalMode('pest')" id="btn-pest" class="py-2.5 bg-slate-800 border border-white/10 rounded-xl text-[9px] font-black uppercase text-red-400">üêõ Pest</button>
                <button onclick="setTacticalMode('yield')" id="btn-yield" class="py-2.5 bg-slate-800 border border-white/10 rounded-xl text-[9px] font-black uppercase text-yellow-400">üí∞ Yield</button>
            </div>
            <div id="trash-bin" ondragover="event.preventDefault()" ondrop="deleteItem(event)" class="mt-4 py-3 border-2 border-dashed border-red-900/30 rounded-xl text-[8px] font-bold text-red-500/50 text-center uppercase">üóëÔ∏è Drop to Delete</div>
        </div>
    </aside>

    <main class="flex-grow overflow-auto bg-slate-950 p-20 flex items-center justify-center relative">
        <div id="viewport" ondragover="event.preventDefault()" ondrop="handleDrop(event)"></div>
        <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-[700px] bg-slate-900/90 border border-white/10 p-6 rounded-3xl backdrop-blur-xl z-[200]">
            <input type="range" min="60" max="300" step="1" value="165" id="time-scrubber" oninput="renderAll()" class="w-full accent-pink-500 bg-slate-700 h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-center text-[9px] font-bold text-slate-400 mt-3 uppercase tracking-[0.3em]">Season Pulse ‚Äî <span id="pulse-date" class="text-white">Jun 15</span></p>
        </div>
    </main>

<script>
    const SUPABASE_URL = 'https://zrohwzqaksqruywiedxt.supabase.co';
    const SUPABASE_KEY = 'YOUR_KEY_HERE'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let bedData = [], plantData = [], healthScans = [], activeTacticalTool = null;
    let heatmapActive = false, soilMapActive = false, rotationYear = 2026;

    function createGrid() {
        const vp = document.getElementById('viewport');
        for (let i = 0; i < 400; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = `cell-${i}`;
            cell.onclick = () => activeTacticalTool ? applyTactical(i) : showProximityAlert(i);
            vp.appendChild(cell);
        }
    }

    function getNeighboringIds(cellId, totalCols = 20) {
        const id = parseInt(cellId);
        const neighbors = [];
        const offsets = [-21, -20, -19, -1, 1, 19, 20, 21];
        offsets.forEach(o => {
            const nId = id + o;
            if (nId >= 0 && nId < 400) neighbors.push(nId);
        });
        return neighbors;
    }

    async function toggleHeatmap(active) {
        heatmapActive = active;
        if (active) {
            const { data } = await _supabase.from('plant_health_scans').select('*').eq('is_resolved', false);
            healthScans = data || [];
        }
        renderAll();
    }

    function toggleSoilMap(active) { soilMapActive = active; renderAll(); }

    function setRotationYear(year) {
        rotationYear = year;
        document.getElementById('rot-2026').className = year === 2026 ? 'flex-1 py-1 bg-amber-600 text-white rounded-lg text-[10px] font-black' : 'flex-1 py-1 bg-white/5 text-slate-500 rounded-lg text-[10px] font-black';
        document.getElementById('rot-2027').className = year === 2027 ? 'flex-1 py-1 bg-amber-600 text-white rounded-lg text-[10px] font-black' : 'flex-1 py-1 bg-white/5 text-slate-500 rounded-lg text-[10px] font-black';
        renderAll();
    }

    function renderSpecialLayers() {
        document.querySelectorAll('.grid-cell').forEach(c => {
            c.classList.remove('pathogen-high', 'vulnerability-warning', 'soil-depleted');
        });

        if (heatmapActive) {
            healthScans.forEach(scan => {
                const cell = document.getElementById(`cell-${scan.spatial_id}`);
                if (cell) {
                    if (scan.severity_level >= 8) cell.classList.add('pathogen-high');
                    getNeighboringIds(scan.spatial_id).forEach(nId => {
                        document.getElementById(`cell-${nId}`)?.classList.add('vulnerability-warning');
                    });
                }
            });
        }

        if (soilMapActive || rotationYear === 2027) {
            plantData.forEach(p => {
                const cellId = Math.floor(p.y / 50) * 20 + Math.floor(p.x / 50);
                if (p.name === 'Tomato') document.getElementById(`cell-${cellId}`)?.classList.add('soil-depleted');
            });
        }
    }

    function updateInsights() {
        const heavyFeeders = plantData.filter(p => p.name === 'Tomato').length;
        const nitrogen = Math.max(0, 100 - (heavyFeeders * 12));
        const nStat = document.getElementById('nitrogen-stat');
        
        nStat.innerText = nitrogen < 50 ? 'Depleted' : 'Optimal';
        nStat.className = `text-[10px] font-black uppercase tracking-widest ${nitrogen < 50 ? 'text-red-500' : 'text-green-400'}`;

        document.getElementById('insights-list').innerHTML = `
            <div class="flex justify-between"><span>Live Plants:</span><span class="font-bold text-white">${plantData.length}</span></div>
            <div class="flex justify-between"><span>Soil Nitrogen:</span><span class="font-bold text-white">${nitrogen}%</span></div>
            <div class="flex justify-between"><span>Pest Risk:</span><span class="font-bold ${healthScans.length > 0 ? 'text-red-400' : 'text-slate-500'}">${healthScans.length > 0 ? 'High' : 'Low'}</span></div>
        `;
    }

    // Standard Drag/Drop/Render
    function startBedDrag(e, type, w, h) { e.dataTransfer.setData("itemType", "bed"); e.dataTransfer.setData("type", type); e.dataTransfer.setData("w", w); e.dataTransfer.setData("h", h); e.dataTransfer.setData("isNew", "true"); }
    function startPlantDrag(e, name, icon, spread, dtm, bloomStart) { e.dataTransfer.setData("itemType", "plant"); e.dataTransfer.setData("name", name); e.dataTransfer.setData("icon", icon); e.dataTransfer.setData("dtm", dtm); e.dataTransfer.setData("bloomStart", bloomStart); e.dataTransfer.setData("isNew", "true"); }

    function handleDrop(e) {
        const rect = document.getElementById('viewport').getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        const itemType = e.dataTransfer.getData("itemType");
        if (itemType === "bed") {
            if (e.dataTransfer.getData("isNew") === "true") {
                const w = parseInt(e.dataTransfer.getData("w")), h = parseInt(e.dataTransfer.getData("h"));
                bedData.push({ id: Date.now(), type: e.dataTransfer.getData("type"), x: x-(w/2), y: y-(h/2), w, h });
            } else {
                const bed = bedData.find(b => b.id == e.dataTransfer.getData("id"));
                if (bed) { bed.x = x-(bed.w/2); bed.y = y-(bed.h/2); }
            }
        } else if (itemType === "plant") {
            if (e.dataTransfer.getData("isNew") === "true") {
                plantData.push({ id: Date.now(), name: e.dataTransfer.getData("name"), icon: e.dataTransfer.getData("icon"), dtm: parseInt(e.dataTransfer.getData("dtm")), bloomStart: parseInt(e.dataTransfer.getData("bloomStart")), x, y });
            } else {
                const plant = plantData.find(p => p.id == e.dataTransfer.getData("id"));
                if (plant) { plant.x = x; plant.y = y; }
            }
        }
        renderAll();
    }

    function renderAll() {
        document.querySelectorAll('.bed-obj, .plant-obj').forEach(el => el.remove());
        const simDay = parseInt(document.getElementById('time-scrubber').value);
        const date = new Date(2026, 0); date.setDate(simDay);
        document.getElementById('pulse-date').innerText = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        renderSpecialLayers();
        bedData.forEach(bed => {
            const el = document.createElement('div'); el.className = `bed-obj type-${bed.type}`;
            el.style.cssText = `left:${bed.x}px;top:${bed.y}px;width:${bed.w}px;height:${bed.h}px;`;
            el.innerText = bed.type; el.draggable = true;
            el.ondragstart = (e) => { e.dataTransfer.setData("itemType", "bed"); e.dataTransfer.setData("id", bed.id); e.dataTransfer.setData("isNew", "false"); };
            document.getElementById('viewport').appendChild(el);
        });
        plantData.forEach(p => {
            const age = simDay - 120;
            const growth = Math.max(0, Math.min(1, age / p.dtm));
            const blooming = simDay >= p.bloomStart && simDay <= (p.bloomStart + 40);
            const el = document.createElement('div'); el.className = `plant-obj ${blooming ? 'stage-bloom' : ''}`;
            el.style.cssText = `left:${p.x-20}px;top:${p.y-20}px; transform: scale(${0.3 + (growth * 0.7)}); opacity: ${age < -5 ? 0 : 1}`;
            el.innerText = p.icon; el.draggable = true;
            el.ondragstart = (e) => { e.dataTransfer.setData("itemType", "plant"); e.dataTransfer.setData("id", p.id); e.dataTransfer.setData("isNew", "false"); };
            document.getElementById('viewport').appendChild(el);
        });
        updateInsights();
    }

    function setTacticalMode(m) { activeTacticalTool = (activeTacticalTool === m) ? null : m; document.querySelectorAll('[id^="btn-"]').forEach(b => b.classList.remove('active-btn')); if (activeTacticalTool) document.getElementById(`btn-${m}`).classList.add('active-btn'); }
    function applyTactical(id) { if (activeTacticalTool) { document.getElementById(`cell-${id}`).classList.toggle(`tag-${activeTacticalTool}`); updateInsights(); } }
    function deleteItem(e) { const id = e.dataTransfer.getData("id"); bedData = bedData.filter(b => b.id != id); plantData = plantData.filter(p => p.id != id); renderAll(); }

    window.onload = () => { createGrid(); renderAll(); };
</script>
</body>
</html>
