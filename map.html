<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Studio | GardenHub OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; overflow: hidden; color: white; }
        
        #viewport { 
            background-color: #0f172a;
            position: relative;
            width: 1000px;
            height: 1000px;
            display: grid;
            grid-template-columns: repeat(20, 50px);
            grid-template-rows: repeat(20, 50px);
            gap: 2px;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .grid-cell {
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s, box-shadow 0.3s;
            z-index: 5;
            position: relative;
        }

        /* Tactical Shades */
        .tag-frost { background: rgba(99, 102, 241, 0.4) !important; border-color: #6366f1 !important; }
        .tag-wet { background: rgba(6, 182, 212, 0.4) !important; border-color: #06b6d4 !important; }

        /* Structural Bed Objects */
        .bed-obj { 
            position: absolute; cursor: move; 
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 900; text-transform: uppercase;
            border-radius: 8px; z-index: 50;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .type-raised { background: #92400e; border: 2px solid #78350f; color: #fef3c7; }
        .type-inground { background: #065f46; border: 2px solid #064e3b; color: #d1fae5; }
        .type-wall { background: #334155; border: 2px solid #475569; color: #f1f5f9; }

        .sidebar-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
        .season-btn.active { background-color: #f59e0b; color: #000; border-color: #f59e0b; }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-80 sidebar-panel border-r border-white/10 p-6 flex flex-col z-[100] overflow-y-auto">
        <div class="mb-8">
            <h2 class="text-[10px] font-black text-green-500 uppercase tracking-widest mb-1">Eco-Intelligence v3.0</h2>
            <p class="text-xl font-black text-white leading-tight uppercase">Spatial Studio</p>
        </div>

        <div class="mb-8">
            <p class="text-[9px] font-bold text-slate-500 uppercase px-1 mb-3">Structural Blueprints</p>
            <div class="grid grid-cols-2 gap-2">
                <div class="p-3 bg-slate-800 rounded-xl border border-white/5 text-[9px] font-bold text-center cursor-grab hover:border-green-500 transition" 
                     draggable="true" ondragstart="startBedDrag(event, 'raised', 150, 100)">üü´ Raised Bed</div>
                <div class="p-3 bg-slate-800 rounded-xl border border-white/5 text-[9px] font-bold text-center cursor-grab hover:border-green-500 transition" 
                     draggable="true" ondragstart="startBedDrag(event, 'inground', 100, 100)">üå± In-Ground</div>
                <div class="p-3 bg-slate-700 rounded-xl border border-white/5 text-[9px] font-bold text-center cursor-grab hover:border-green-500 transition col-span-2" 
                     draggable="true" ondragstart="startBedDrag(event, 'wall', 200, 20)">üß± Heat-Reflective Wall</div>
            </div>
        </div>

        <div class="mb-8 p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl">
            <p class="text-[9px] font-black text-amber-500 uppercase mb-3">Seasonal Heliophysics</p>
            <div class="flex gap-1 mb-4">
                <button onclick="setSeason('spring')" id="btn-spring" class="season-btn flex-1 p-2 bg-slate-800 rounded-lg text-[8px] font-bold uppercase">Spring</button>
                <button onclick="setSeason('summer')" id="btn-summer" class="season-btn flex-1 p-2 bg-slate-800 rounded-lg text-[8px] font-bold uppercase active">Summer</button>
                <button onclick="setSeason('fall')" id="btn-fall" class="season-btn flex-1 p-2 bg-slate-800 rounded-lg text-[8px] font-bold uppercase">Fall</button>
            </div>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="heat-toggle" onchange="toggleHeatMap()" class="w-4 h-4 rounded border-slate-700 bg-slate-900 accent-orange-500">
                <span class="text-[10px] font-bold text-slate-300 uppercase">üî• Heat Amplification</span>
            </label>
        </div>

        <div class="mb-8">
            <p class="text-[9px] font-bold text-slate-500 uppercase px-1 mb-3">Tactical Overlays</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setTacticalMode('frost')" id="btn-frost" class="p-3 bg-indigo-900/20 border border-indigo-500/30 rounded-xl text-[9px] font-black uppercase text-indigo-300">‚ùÑÔ∏è Frost</button>
                <button onclick="setTacticalMode('wet')" id="btn-wet" class="p-3 bg-cyan-900/20 border border-cyan-500/30 rounded-xl text-[9px] font-black uppercase text-cyan-300">üíß Wet Zone</button>
                <button onclick="setTacticalMode(null)" class="col-span-2 mt-2 text-[8px] uppercase text-slate-500 font-bold">Clear Tool Selection</button>
            </div>
        </div>

        <div class="mt-auto space-y-3">
            <div id="trash-bin" ondragover="event.preventDefault()" ondrop="deleteBed(event)" class="py-4 border-2 border-dashed border-slate-800 rounded-2xl text-[9px] font-bold text-slate-600 text-center uppercase">
                üóëÔ∏è Drop Bed to Delete
            </div>
            <button onclick="saveLayout()" class="w-full py-4 bg-white text-slate-900 rounded-2xl text-[10px] font-black uppercase tracking-widest">Sync Garden DNA</button>
        </div>
    </aside>

    <main class="flex-grow overflow-auto bg-slate-950 p-20 flex items-center justify-center">
        <div id="viewport" ondragover="event.preventDefault()" ondrop="dropBed(event)"></div>
    </main>

<script>
    const SUPABASE_URL = 'https://zrohwzqaksqruywiedxt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyb2h3enFha3NxcnV5d2llZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzUwOTYsImV4cCI6MjA4NzQ1MTA5Nn0.cS8_C2WCdqH-e_ysxooH2wbarlxmi-S6CDZkevg_DPM'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let activeTacticalTool = null;
    let tacticalData = {}; 
    let bedData = [];
    let currentSeason = 'summer';
    let heatMapActive = false;

    const SEASON_OFFSETS = {
        'spring': { shadowLength: 1.5, intensity: 0.1 },
        'summer': { shadowLength: 0.4, intensity: 0.2 },
        'fall': { shadowLength: 2.2, intensity: 0.05 }
    };

    function createGrid() {
        const viewport = document.getElementById('viewport');
        for (let i = 0; i < 400; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = `cell-${i}`;
            cell.onclick = () => applyTactical(i);
            viewport.appendChild(cell);
        }
    }

    function setTacticalMode(mode) {
        activeTacticalTool = mode;
        document.getElementById('btn-frost').classList.toggle('bg-indigo-600', mode === 'frost');
        document.getElementById('btn-wet').classList.toggle('bg-cyan-600', mode === 'wet');
    }

    function applyTactical(cellId) {
        if (activeTacticalTool) {
            const cell = document.getElementById(`cell-${cellId}`);
            if (cell.classList.contains(`tag-${activeTacticalTool}`)) {
                cell.classList.remove(`tag-${activeTacticalTool}`);
                delete tacticalData[cellId];
            } else {
                cell.classList.remove('tag-frost', 'tag-wet');
                cell.classList.add(`tag-${activeTacticalTool}`);
                tacticalData[cellId] = activeTacticalTool;
            }
        }
    }

    // --- HELIOPHYSICS ENGINE ---
    function setSeason(s) {
        currentSeason = s;
        document.querySelectorAll('.season-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${s}`).classList.add('active');
        updateMicroclimateVisuals();
    }

    function toggleHeatMap() {
        heatMapActive = document.getElementById('heat-toggle').checked;
        updateMicroclimateVisuals();
    }

    function updateMicroclimateVisuals() {
        const seasonData = SEASON_OFFSETS[currentSeason];
        const cells = document.querySelectorAll('.grid-cell');
        
        cells.forEach((cell, index) => {
            const row = Math.floor(index / 20);
            const col = index % 20;
            const cx = col * 50;
            const cy = row * 50;
            
            let sunScore = 1.0; 
            let heatBoost = 0;

            bedData.forEach(obj => {
                // Shadow Logic (Cast Shadows Northwards)
                if (obj.type === 'wall' || obj.type === 'raised') {
                    const shadowHeight = obj.height * seasonData.shadowLength;
                    if (cx >= obj.x && cx <= (obj.x + obj.w) &&
                        cy < obj.y && cy > (obj.y - shadowHeight)) {
                        sunScore = 0.3; 
                    }
                }
                // Heat Amplification (Southern Face of Walls)
                if (heatMapActive && obj.type === 'wall') {
                    if (cx >= obj.x && cx <= (obj.x + obj.w) &&
                        cy >= (obj.y + obj.h) && cy <= (obj.y + obj.h + 100)) {
                        heatBoost = 1;
                    }
                }
            });

            // Visual Application
            if (sunScore < 0.5) {
                cell.style.boxShadow = 'inset 0 0 15px rgba(30, 27, 75, 0.8)';
                cell.style.backgroundColor = 'rgba(49, 46, 129, 0.2)';
            } else if (heatBoost > 0) {
                cell.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
                cell.style.boxShadow = 'inset 0 0 10px rgba(239, 68, 68, 0.3)';
            } else {
                cell.style.backgroundColor = `rgba(251, 191, 36, ${seasonData.intensity})`;
                cell.style.boxShadow = 'none';
            }
        });
    }

    // --- BED LOGIC ---
    function startBedDrag(e, type, w, h) {
        e.dataTransfer.setData("type", type);
        e.dataTransfer.setData("w", w);
        e.dataTransfer.setData("h", h);
        e.dataTransfer.setData("isNew", "true");
    }

    function dropBed(e) {
        const isNew = e.dataTransfer.getData("isNew");
        const rect = document.getElementById('viewport').getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (isNew === "true") {
            const type = e.dataTransfer.getData("type");
            const w = parseInt(e.dataTransfer.getData("w"));
            const h = parseInt(e.dataTransfer.getData("h"));
            bedData.push({ id: Date.now(), type, x: x - (w/2), y: y - (h/2), w, h });
        } else {
            const id = parseInt(e.dataTransfer.getData("bedId"));
            const bed = bedData.find(b => b.id === id);
            if (bed) {
                bed.x = x - (bed.w / 2);
                bed.y = y - (bed.h / 2);
            }
        }
        renderBeds();
        updateMicroclimateVisuals();
    }

    function renderBeds() {
        document.querySelectorAll('.bed-obj').forEach(b => b.remove());
        const viewport = document.getElementById('viewport');

        bedData.forEach(bed => {
            const el = document.createElement('div');
            el.className = `bed-obj type-${bed.type}`;
            el.style.left = `${bed.x}px`;
            el.style.top = `${bed.y}px`;
            el.style.width = `${bed.w}px`;
            el.style.height = `${bed.h}px`;
            el.innerText = bed.type;
            el.draggable = true;
            el.ondragstart = (e) => {
                e.dataTransfer.setData("bedId", bed.id);
                e.dataTransfer.setData("isNew", "false");
            };
            viewport.appendChild(el);
        });
    }

    function deleteBed(e) {
        const id = parseInt(e.dataTransfer.getData("bedId"));
        bedData = bedData.filter(b => b.id !== id);
        renderBeds();
        updateMicroclimateVisuals();
    }

    async function saveLayout() {
        const { data: { user } } = await _supabase.auth.getUser();
        await _supabase.from('garden_settings').upsert([
            { key: 'spatial_beds', value: bedData, user_id: user.id },
            { key: 'microclimate_tags', value: tacticalData, user_id: user.id }
        ], { onConflict: 'user_id, key' });
        alert("Garden DNA & Heliophysics Synced!");
    }

    window.onload = () => {
        createGrid();
        setSeason('summer'); // Default view
    };
</script>
</body>
</html>
