<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GardenHub OS | Spatial Studio v10.6</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;1,9..144,300&display=swap" rel="stylesheet"/>

<style>
/* â”€â”€ Design Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:         #0b110d;
  --surface:    #111a13;
  --surface2:   #172019;
  --border:     #1d2e20;
  --border2:    #243628;
  --green:      #3ddc6e;
  --green-dim:  #1a6b34;
  --green-pale: #a8f0b8;
  --amber:      #f5a623;
  --red:        #f05252;
  --blue:       #5ba4f5;
  --soil:       #8b5c2a;
  --mono:       'DM Mono', monospace;
  --serif:      'Fraunces', serif;
  --sidebar-w:  320px;
  --bottom-h:   90px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  font-family: var(--mono);
  color: #c8dfc8;
  display: flex;
  height: 100vh;
  overflow: hidden;
  cursor: crosshair;
}

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--green-dim); border-radius: 2px; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 200;
  position: relative;
}

.sidebar-logo {
  padding: 1.1rem 1.25rem 0.75rem;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo .eyebrow {
  font-size: 0.55rem;
  letter-spacing: 0.25em;
  color: var(--green-dim);
  text-transform: uppercase;
}
.sidebar-logo .title {
  font-family: var(--serif);
  font-size: 1.5rem;
  font-weight: 700;
  color: #e8f5e8;
  letter-spacing: -0.03em;
  line-height: 1.1;
}

.sidebar-section {
  border-bottom: 1px solid var(--border);
  padding: 0.9rem 1.1rem;
}
.section-label {
  font-size: 0.52rem;
  letter-spacing: 0.22em;
  color: var(--green-dim);
  text-transform: uppercase;
  margin-bottom: 0.65rem;
}

/* â”€â”€ Panel / Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.7rem 0.85rem;
  margin-bottom: 0.5rem;
  font-size: 0.65rem;
}
.panel:last-child { margin-bottom: 0; }

/* â”€â”€ KV row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kv { display: flex; justify-content: space-between; align-items: center; padding: 0.2rem 0; font-size: 0.62rem; }
.kv-label { color: #5a7a60; }
.kv-val   { color: #c8dfc8; font-weight: 500; }
.kv-val.good   { color: var(--green); }
.kv-val.warn   { color: var(--amber); }
.kv-val.danger { color: var(--red); }

/* â”€â”€ Year toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.year-toggle { display: flex; gap: 0.4rem; margin-bottom: 0.6rem; }
.year-btn {
  flex: 1; padding: 0.3rem 0;
  font-family: var(--mono); font-size: 0.6rem; font-weight: 500;
  background: var(--surface2); border: 1px solid var(--border2);
  color: #5a7a60; cursor: pointer; border-radius: 3px;
  transition: all 0.15s;
}
.year-btn.active { background: var(--amber); border-color: var(--amber); color: var(--bg); }

/* â”€â”€ Layer Toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layer-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.45rem 0.6rem;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 3px; margin-bottom: 0.35rem; cursor: pointer;
  transition: border-color 0.15s;
}
.layer-row:hover { border-color: var(--border2); }
.layer-name { font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase; color: #8aab8a; }

.toggle-pill {
  width: 28px; height: 14px;
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 7px; position: relative; transition: background 0.2s;
}
.toggle-pill::after {
  content: '';
  position: absolute; top: 2px; left: 2px;
  width: 8px; height: 8px;
  background: #3a5040; border-radius: 50%;
  transition: all 0.2s;
}
.layer-row.on .toggle-pill { background: var(--green-dim); border-color: var(--green); }
.layer-row.on .toggle-pill::after { left: 16px; background: var(--green); }

/* â”€â”€ Inventory Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.inv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
.inv-item {
  padding: 0.55rem 0.5rem;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 4px; cursor: grab; font-size: 0.6rem;
  display: flex; align-items: center; gap: 0.4rem;
  transition: all 0.15s; user-select: none; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.inv-item:hover { border-color: var(--green-dim); color: var(--green-pale); }
.inv-item:active { cursor: grabbing; opacity: 0.7; }
.inv-item .badge {
  font-size: 0.45rem; padding: 0.05rem 0.3rem;
  border-radius: 2px; font-weight: 500; letter-spacing: 0.08em;
  flex-shrink: 0;
}
.badge-native { background: rgba(61,220,110,0.15); color: var(--green); border: 1px solid var(--green-dim); }
.badge-host   { background: rgba(91,164,245,0.15); color: var(--blue);  border: 1px solid #2a5580; }
.badge-loading { color: var(--green-dim); font-size: 0.6rem; padding: 0.5rem; text-align: center; width: 100%; }

/* â”€â”€ Tactical Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tactic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }
.tactic-btn {
  padding: 0.55rem 0.25rem;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 3px; font-family: var(--mono); font-size: 0.58rem;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: #8aab8a; cursor: pointer; text-align: center;
  transition: all 0.15s;
}
.tactic-btn:hover { border-color: var(--green-dim); }
.tactic-btn.active-frost  { background: rgba(99,102,241,0.25); border-color: #6366f1; color: #a5b4fc; }
.tactic-btn.active-wet    { background: rgba(6,182,212,0.2);   border-color: #06b6d4; color: #67e8f9; }
.tactic-btn.active-pest   { background: rgba(240,82,82,0.2);   border-color: var(--red); color: #fca5a5; }
.tactic-btn.active-yield  { background: rgba(245,166,35,0.2);  border-color: var(--amber); color: #fcd34d; }

/* â”€â”€ Alert Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#alert-panel {
  margin: 0.75rem 1.1rem;
  padding: 0.6rem 0.75rem;
  background: rgba(240,82,82,0.08);
  border: 1px solid rgba(240,82,82,0.4);
  border-radius: 4px;
  font-size: 0.62rem; line-height: 1.5;
  color: #fca5a5;
  display: none;
}
#alert-panel.companion { background: rgba(245,166,35,0.08); border-color: rgba(245,166,35,0.4); color: #fcd34d; }
#alert-panel.info      { background: rgba(61,220,110,0.06); border-color: rgba(61,220,110,0.3); color: var(--green-pale); }

/* â”€â”€ Trash bin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#trash-bin {
  margin: 0 1.1rem 0.9rem;
  padding: 0.6rem;
  border: 1.5px dashed rgba(240,82,82,0.25);
  border-radius: 4px;
  text-align: center;
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  color: rgba(240,82,82,0.4);
  text-transform: uppercase;
  transition: all 0.2s;
}
#trash-bin.drag-over {
  border-color: var(--red);
  color: var(--red);
  background: rgba(240,82,82,0.08);
}

/* â”€â”€ Main / Viewport Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

#canvas-scroll {
  flex: 1;
  overflow: auto;
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
  padding: 2rem;
  background:
    radial-gradient(ellipse at 20% 20%, rgba(30,60,35,0.18) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 80%, rgba(20,40,25,0.12) 0%, transparent 55%),
    var(--bg);
}

/* â”€â”€ Grid Viewport â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#viewport {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border);
  flex-shrink: 0;
  /* 24 cols Ã— 48px = 1152px, 18 rows Ã— 48px = 864px */
  width:  1152px;
  height: 864px;
}

/* â”€â”€ Grid Cells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid-cell {
  position: absolute;
  width: 48px; height: 48px;
  border-right: 1px solid rgba(255,255,255,0.03);
  border-bottom: 1px solid rgba(255,255,255,0.03);
  transition: background 0.12s;
  cursor: crosshair;
}
.grid-cell:hover { background: rgba(61,220,110,0.06) !important; }

/* tactical tags */
.tag-frost { background: rgba(99,102,241,0.3) !important; border-color: #6366f1 !important; }
.tag-wet   { background: rgba(6,182,212,0.3)  !important; border-color: #06b6d4 !important; }
.tag-pest  { background: rgba(240,82,82,0.3)  !important; border-color: var(--red) !important; }
.tag-yield { background: rgba(245,166,35,0.3) !important; border-color: var(--amber) !important; }

/* overlay layers */
.pathogen-high   { background: rgba(240,82,82,0.45)  !important; animation: pulse-r 2s infinite; }
.pathogen-med    { background: rgba(245,166,35,0.3)  !important; }
.vuln-warning    { box-shadow: inset 0 0 0 1px rgba(240,82,82,0.5) !important; }
.soil-depleted   { background: rgba(139,92,42,0.35)  !important; }
.sun-full        { background: rgba(245,166,35,0.22) !important; }
.sun-partial     { background: rgba(245,166,35,0.10) !important; }
.sun-shade       { background: rgba(30,60,80,0.35)   !important; }
.rotation-warn   { box-shadow: inset 0 0 0 2px rgba(240,82,82,0.6) !important; }
.companion-ok    { box-shadow: inset 0 0 0 1px rgba(61,220,110,0.5) !important; }
.companion-bad   { box-shadow: inset 0 0 0 2px rgba(240,82,82,0.7) !important; }

@keyframes pulse-r { 0%,100% { opacity:1; } 50% { opacity:0.45; } }

/* â”€â”€ Placed Objects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Beds */
.bed-obj {
  position: absolute;
  border-radius: 4px;
  cursor: move;
  z-index: 20;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.5rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  user-select: none;
}
.bed-raised    { background: rgba(100,60,20,0.75); border: 2px solid #78450f; color: #f5deb3; }
.bed-container { background: rgba(30,60,80,0.75);  border: 2px solid #2a5f7a; color: #b3d9f5; }
.bed-wall      { background: rgba(50,60,70,0.8);   border: 2px solid #4a5568; color: #e2e8f0; }

/* Resize handle */
.resize-handle {
  position: absolute;
  bottom: 0; right: 0;
  width: 12px; height: 12px;
  cursor: se-resize;
  background: rgba(255,255,255,0.15);
  border-top-left-radius: 3px;
}

/* Plants */
.plant-obj {
  position: absolute;
  z-index: 50;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
  cursor: pointer;
  border-radius: 50%;
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
  user-select: none;
}
.plant-obj:hover .spread-ring { opacity: 1 !important; }
.plant-obj.stage-bloom {
  box-shadow: 0 0 14px rgba(236,72,153,0.7);
  border: 1.5px solid #ec4899;
}
.plant-obj.companion-conflict { border: 2px solid var(--red); box-shadow: 0 0 10px rgba(240,82,82,0.5); }
.plant-obj.native-marker  { border: 1.5px solid var(--green-dim); }
.plant-obj.host-marker    { border: 1.5px solid var(--blue); }

/* Spread ring */
.spread-ring {
  position: absolute;
  border-radius: 50%;
  border: 1.5px dashed rgba(61,220,110,0.35);
  pointer-events: none;
  opacity: 0.5;
  transition: opacity 0.2s, border-color 0.2s;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
}
.spread-ring.conflict { border-color: rgba(240,82,82,0.55) !important; }

/* Tooltip */
.plant-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  border: 1px solid var(--border2);
  padding: 0.4rem 0.6rem;
  border-radius: 4px;
  font-size: 0.58rem;
  white-space: nowrap;
  pointer-events: none;
  z-index: 100;
  display: none;
  color: var(--green-pale);
  box-shadow: 0 4px 16px rgba(0,0,0,0.6);
}
.plant-tooltip::after {
  content: '';
  position: absolute;
  top: 100%; left: 50%;
  transform: translateX(-50%);
  border: 4px solid transparent;
  border-top-color: var(--border2);
}
.plant-obj:hover .plant-tooltip { display: block; }

/* â”€â”€ Season Scrubber bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#scrubber-bar {
  height: var(--bottom-h);
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 0.9rem 2rem;
  display: flex; align-items: center; gap: 1.5rem;
  flex-shrink: 0;
  z-index: 100;
}
#scrubber-bar label { font-size: 0.55rem; letter-spacing: 0.2em; color: var(--green-dim); text-transform: uppercase; white-space: nowrap; }
#time-scrubber {
  flex: 1; height: 3px;
  -webkit-appearance: none;
  background: var(--border2);
  border-radius: 2px;
  cursor: pointer;
  outline: none;
}
#time-scrubber::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: var(--green);
  cursor: pointer;
  box-shadow: 0 0 8px rgba(61,220,110,0.5);
}
#pulse-date {
  font-family: var(--serif);
  font-size: 1rem;
  color: #e8f5e8;
  min-width: 70px;
  letter-spacing: -0.02em;
}
#season-badge {
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  padding: 0.2rem 0.5rem;
  border: 1px solid var(--border2);
  border-radius: 2px;
  color: var(--amber);
  text-transform: uppercase;
  white-space: nowrap;
}

/* â”€â”€ Save indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#save-indicator {
  position: fixed; top: 0.75rem; right: 1rem;
  font-size: 0.55rem; letter-spacing: 0.15em;
  color: var(--green-dim); text-transform: uppercase;
  opacity: 0; transition: opacity 0.3s;
  z-index: 999;
}
#save-indicator.show { opacity: 1; }

/* â”€â”€ Auth Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#auth-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(11,17,13,0.97);
  display: flex; align-items: center; justify-content: center;
}
#auth-overlay.hidden { display: none; }
.auth-box {
  border: 1px solid var(--green);
  background: var(--surface);
  padding: 2.25rem;
  width: 340px;
  position: relative;
}
.auth-box::before {
  content: 'SPATIAL STUDIO // AUTH';
  font-size: 0.52rem; color: var(--green-dim);
  letter-spacing: 0.2em; text-transform: uppercase;
  position: absolute; top: -0.6rem; left: 1rem;
  background: var(--surface); padding: 0 0.4rem;
}
.auth-title { font-family: var(--serif); font-size: 1.6rem; color: var(--green); font-weight: 700; margin-bottom: 1.25rem; }
.auth-input {
  width: 100%; background: var(--bg); border: 1px solid var(--border);
  color: #c8dfc8; padding: 0.55rem 0.7rem;
  font-family: var(--mono); font-size: 0.72rem;
  margin-bottom: 0.6rem; outline: none; transition: border-color 0.2s;
}
.auth-input:focus { border-color: var(--green); }
.auth-btn {
  width: 100%; background: var(--green); color: var(--bg);
  font-family: var(--mono); font-size: 0.7rem; font-weight: 700;
  letter-spacing: 0.12em; padding: 0.65rem; border: none; cursor: pointer;
  text-transform: uppercase; margin-bottom: 0.45rem; transition: opacity 0.2s;
}
.auth-btn:hover { opacity: 0.85; }
.auth-btn.ghost {
  background: transparent; border: 1px solid var(--border);
  color: #5a7a60;
}
#auth-err { font-size: 0.6rem; color: var(--red); min-height: 1rem; margin-bottom: 0.4rem; }

/* â”€â”€ Context menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#ctx-menu {
  position: fixed; z-index: 500;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 0.3rem 0;
  min-width: 140px;
  display: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);
}
.ctx-item {
  padding: 0.45rem 0.85rem;
  font-size: 0.62rem;
  cursor: pointer;
  color: #8aab8a;
  transition: background 0.1s;
}
.ctx-item:hover { background: var(--surface2); color: var(--green-pale); }
.ctx-item.danger { color: var(--red); }
.ctx-item.danger:hover { background: rgba(240,82,82,0.1); }
.ctx-sep { height: 1px; background: var(--border); margin: 0.25rem 0; }
</style>
</head>

<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-title">Spatial Studio</div>
    <input id="a-email" class="auth-input" type="email" placeholder="email" autocomplete="email"/>
    <input id="a-pass"  class="auth-input" type="password" placeholder="password" autocomplete="current-password"/>
    <div id="auth-err"></div>
    <button class="auth-btn" id="btn-login">Initialize Session</button>
    <button class="auth-btn ghost" id="btn-reg">Register</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside id="sidebar">
  <div class="sidebar-logo">
    <div class="eyebrow">GardenHub OS // v10.6</div>
    <div class="title">Spatial<br/>Studio</div>
  </div>

  <!-- Crop Rotation -->
  <div class="sidebar-section">
    <div class="section-label">Crop Rotation & Soil</div>
    <div class="year-toggle">
      <button class="year-btn active" id="rot-2026" onclick="setYear(2026)">2026</button>
      <button class="year-btn"        id="rot-2027" onclick="setYear(2027)">2027</button>
      <button class="year-btn"        id="rot-2028" onclick="setYear(2028)">2028</button>
    </div>
    <div class="panel">
      <div class="kv"><span class="kv-label">Nitrogen Health</span><span class="kv-val" id="kv-nitrogen">Optimal</span></div>
      <div class="kv"><span class="kv-label">Rotation Conflicts</span><span class="kv-val" id="kv-rotation">0</span></div>
      <div class="kv"><span class="kv-label">Soil Score</span><span class="kv-val" id="kv-soil">100%</span></div>
    </div>
  </div>

  <!-- Companion Alerts -->
  <div id="alert-panel"></div>

  <!-- Memory Insights -->
  <div class="sidebar-section">
    <div class="section-label">Memory Insights</div>
    <div class="panel">
      <div class="kv"><span class="kv-label">Live Plants</span><span class="kv-val" id="kv-plants">0</span></div>
      <div class="kv"><span class="kv-label">Structures</span><span class="kv-val" id="kv-beds">0</span></div>
      <div class="kv"><span class="kv-label">Pest Risk</span><span class="kv-val" id="kv-pest">Low</span></div>
      <div class="kv"><span class="kv-label">Pollinators</span><span class="kv-val" id="kv-pollinators">0 native</span></div>
    </div>
  </div>

  <!-- Map Layers -->
  <div class="sidebar-section">
    <div class="section-label">Map Vision Layers</div>
    <div class="layer-row" id="layer-pathogen" onclick="toggleLayer('pathogen')">
      <span class="layer-name">ğŸ”´ Pathogen Heatmap</span>
      <div class="toggle-pill"></div>
    </div>
    <div class="layer-row" id="layer-soil" onclick="toggleLayer('soil')">
      <span class="layer-name">ğŸŸ¤ Soil Nutrient Map</span>
      <div class="toggle-pill"></div>
    </div>
    <div class="layer-row" id="layer-sun" onclick="toggleLayer('sun')">
      <span class="layer-name">â˜€ï¸ Sun/Shade Overlay</span>
      <div class="toggle-pill"></div>
    </div>
    <div class="layer-row" id="layer-spread" onclick="toggleLayer('spread')">
      <span class="layer-name">ğŸŒ¿ Spread Rings</span>
      <div class="toggle-pill"></div>
    </div>
    <div class="layer-row" id="layer-companion" onclick="toggleLayer('companion')">
      <span class="layer-name">ğŸ¤ Companion Alerts</span>
      <div class="toggle-pill"></div>
    </div>
  </div>

  <!-- Inventory -->
  <div class="sidebar-section" style="flex:1">
    <div class="section-label">Structures</div>
    <div class="inv-grid" style="margin-bottom:0.75rem">
      <div class="inv-item" draggable="true" ondragstart="dragBed(event,'raised',144,96)">ğŸŸ« Raised Bed</div>
      <div class="inv-item" draggable="true" ondragstart="dragBed(event,'container',96,96)">ğŸª´ Container</div>
      <div class="inv-item" draggable="true" ondragstart="dragBed(event,'wall',192,24)">ğŸ§± Heat-Wall</div>
    </div>
    <div class="section-label">Plant Library</div>
    <div class="inv-grid" id="plant-inventory">
      <div class="badge-loading">Loading libraryâ€¦</div>
    </div>
  </div>

  <!-- Tactical Tags -->
  <div class="sidebar-section">
    <div class="section-label">Tactical Tags</div>
    <div class="tactic-grid">
      <button class="tactic-btn" id="btn-frost" onclick="setTactic('frost')">â„ï¸ Frost</button>
      <button class="tactic-btn" id="btn-wet"   onclick="setTactic('wet')">ğŸ’§ Wet</button>
      <button class="tactic-btn" id="btn-pest"  onclick="setTactic('pest')">ğŸ› Pest</button>
      <button class="tactic-btn" id="btn-yield" onclick="setTactic('yield')">ğŸ’° Yield</button>
    </div>
  </div>

  <!-- Trash -->
  <div id="trash-bin"
       ondragover="event.preventDefault(); this.classList.add('drag-over')"
       ondragleave="this.classList.remove('drag-over')"
       ondrop="onTrashDrop(event)">
    ğŸ—‘ Drop to Delete
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="main-area">
  <div id="canvas-scroll">
    <div id="viewport"
         ondragover="event.preventDefault()"
         ondrop="onViewportDrop(event)">
      <!-- grid cells injected by JS -->
    </div>
  </div>

  <!-- Season scrubber -->
  <div id="scrubber-bar">
    <label>Season Pulse</label>
    <span id="pulse-date">Mar 1</span>
    <input type="range" id="time-scrubber" min="60" max="300" step="1" value="60" oninput="onScrub()"/>
    <span id="season-badge">Early Spring</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTEXT MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-info">ğŸ“‹ Plant Info</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" id="ctx-clone">âŠ• Duplicate</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" id="ctx-delete">âœ• Remove</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SAVE INDICATOR â•â•â•â•â•â•â•â•â•â• -->
<div id="save-indicator">âœ“ Saved</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GardenHub OS â€” Spatial Studio v10.6
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUPABASE_URL = 'https://zrohwzqaksqruywiedxt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyb2h3enFha3NxcnV5d2llZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzUwOTYsImV4cCI6MjA4NzQ1MTA5Nn0.cS8_C2WCdqH-e_ysxooH2wbarlxmi-S6CDZkevg_DPM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
window._supabase = sb;

// â”€â”€ Grid constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 24, ROWS = 18, CELL = 48;
const VP_W = COLS * CELL, VP_H = ROWS * CELL; // 1152 Ã— 864

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bedData     = [];   // { id, type, x, y, w, h }
let plantData   = [];   // { id, libId, name, emoji, family, spread, dtm, bloomStart, x, y, isNative, isHost }
let healthScans = [];   // from Supabase
let cellTags    = {};   // cellId â†’ Set of tag strings
let activeTactic   = null;
let rotationYear   = 2026;
let layers = { pathogen: false, soil: false, sun: false, spread: true, companion: true };
let ctxTarget = null;   // currently right-clicked plant/bed id
let isDirty   = false;
let saveTimer  = null;
let userId    = null;
let simDay    = 60;

// â”€â”€ Plant families for rotation logic â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FAMILY_CONFLICTS = {
  Solanaceae: ['Solanaceae'],
  Brassicaceae: ['Brassicaceae'],
  Cucurbitaceae: ['Cucurbitaceae'],
  Apiaceae: ['Apiaceae'],
};
// which family depletes nitrogen (heavy feeders)
const HEAVY_FEEDERS = new Set(['Solanaceae', 'Cucurbitaceae', 'Brassicaceae']);
// which fix nitrogen (legumes)
const N_FIXERS      = new Set(['Fabaceae']);

// â”€â”€ Companion planting matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// good[A] = [B, C] â†’ A benefits from B and C nearby
const COMPANIONS_GOOD = {
  Tomato:  ['Basil','Marigold','Zinnia','Carrot','Parsley'],
  Basil:   ['Tomato','Pepper'],
  Marigold:['Tomato','Pepper','Eggplant','Squash'],
  Zinnia:  ['Tomato'],
  Carrot:  ['Tomato','Lettuce','Onion'],
  Squash:  ['Corn','Bean','Marigold'],
  Bean:    ['Squash','Corn','Carrot'],
  Corn:    ['Bean','Squash'],
  Lettuce: ['Carrot','Strawberry','Radish'],
};
const COMPANIONS_BAD = {
  Tomato:  ['Fennel','Kohlrabi','Brassica'],
  Basil:   ['Sage'],
  Bean:    ['Onion','Fennel'],
  Onion:   ['Bean','Pea'],
  Fennel:  ['Tomato','Bean','Pepper'],
};

// â”€â”€ Sun/shade map: simulate solar by season â”€â”€â”€
// Each cell gets a sun score 0â€“2 based on position + season
// 0 = shade, 1 = partial, 2 = full sun
// Fairfield CT: south-facing (high row index) = more sun
function getSunScore(col, row, dayOfYear) {
  // Seasonal modifier: solar angle lower in spring/fall
  const seasonMod = Math.sin(Math.PI * (dayOfYear - 60) / 240); // 0 at day 60, peaks ~day 180
  // Row bias: bottom rows get more direct sun (south exposure)
  const rowBias = row / ROWS;
  const raw = (rowBias * 0.7 + seasonMod * 0.3);
  if (raw < 0.3) return 0;
  if (raw < 0.6) return 1;
  return 2;
}

// â”€â”€ Grid creation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createGrid() {
  const vp = document.getElementById('viewport');
  for (let row = 0; row < ROWS; row++) {
    for (let col = 0; col < COLS; col++) {
      const i = row * COLS + col;
      const cell = document.createElement('div');
      cell.className = 'grid-cell';
      cell.id = `cell-${i}`;
      cell.style.cssText = `left:${col*CELL}px;top:${row*CELL}px;`;
      cell.dataset.col = col;
      cell.dataset.row = row;
      cell.onclick  = () => onCellClick(i);
      cell.onmouseenter = () => onCellHover(i);
      vp.appendChild(cell);
    }
  }
}

// â”€â”€ Fixed neighbor lookup (no row wrap) â”€â”€â”€â”€â”€â”€
function getNeighbors(cellId, radius = 1) {
  const id  = parseInt(cellId);
  const row = Math.floor(id / COLS);
  const col = id % COLS;
  const result = [];
  for (let dr = -radius; dr <= radius; dr++) {
    for (let dc = -radius; dc <= radius; dc++) {
      if (dr === 0 && dc === 0) continue;
      const nr = row + dr, nc = col + dc;
      if (nr < 0 || nr >= ROWS || nc < 0 || nc >= COLS) continue;
      result.push(nr * COLS + nc);
    }
  }
  return result;
}

// â”€â”€ Cell position helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cellFromXY(x, y) {
  const col = Math.min(COLS - 1, Math.max(0, Math.floor(x / CELL)));
  const row = Math.min(ROWS - 1, Math.max(0, Math.floor(y / CELL)));
  return row * COLS + col;
}
function cellCenter(cellId) {
  const col = cellId % COLS, row = Math.floor(cellId / COLS);
  return { x: col * CELL + CELL/2, y: row * CELL + CELL/2 };
}
function plantsNearCell(cellId, radiusPx = 80) {
  const { x, y } = cellCenter(cellId);
  return plantData.filter(p => Math.hypot(p.x - x, p.y - y) < radiusPx);
}

// â”€â”€ Layer rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearLayerClasses() {
  const classes = ['pathogen-high','pathogen-med','vuln-warning','soil-depleted','sun-full','sun-partial','sun-shade','rotation-warn'];
  document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove(...classes));
}

function renderLayers() {
  clearLayerClasses();

  // Pathogen heatmap
  if (layers.pathogen) {
    healthScans.forEach(scan => {
      const cid = scan.cell_id ?? (scan.spatial_id ?? null);
      if (cid === null) return;
      const el = document.getElementById(`cell-${cid}`);
      if (!el) return;
      if ((scan.severity_level || scan.severity || 0) >= 8) {
        el.classList.add('pathogen-high');
        getNeighbors(cid, 1).forEach(n => document.getElementById(`cell-${n}`)?.classList.add('vuln-warning'));
      } else {
        el.classList.add('pathogen-med');
      }
    });
  }

  // Soil / rotation
  if (layers.soil || rotationYear > 2026) {
    // Mark cells under heavy feeders as depleted
    plantData.forEach(p => {
      if (!HEAVY_FEEDERS.has(p.family)) return;
      const cid = cellFromXY(p.x, p.y);
      document.getElementById(`cell-${cid}`)?.classList.add('soil-depleted');
      // For 2027+ show rotation conflict ring if same family as prior year
      if (rotationYear > 2026) {
        getNeighbors(cid, 2).forEach(n => {
          const el = document.getElementById(`cell-${n}`);
          if (el) el.classList.add('rotation-warn');
        });
      }
    });
  }

  // Sun/shade overlay
  if (layers.sun) {
    for (let row = 0; row < ROWS; row++) {
      for (let col = 0; col < COLS; col++) {
        const i = row * COLS + col;
        const score = getSunScore(col, row, simDay);
        const el = document.getElementById(`cell-${i}`);
        if (!el) continue;
        if (score === 2) el.classList.add('sun-full');
        else if (score === 1) el.classList.add('sun-partial');
        else el.classList.add('sun-shade');
      }
    }
  }

  // Tactical tags (always on top)
  Object.entries(cellTags).forEach(([cid, tags]) => {
    const el = document.getElementById(`cell-${cid}`);
    if (!el) return;
    tags.forEach(t => el.classList.add(`tag-${t}`));
  });
}

// â”€â”€ Companion conflict detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getConflictsForPlant(plant) {
  const bad = COMPANIONS_BAD[plant.name] || [];
  const good = COMPANIONS_GOOD[plant.name] || [];
  // Find plants within 2 cell radius
  const nearby = plantData.filter(p => p.id !== plant.id && Math.hypot(p.x - plant.x, p.y - plant.y) < CELL * 2.5);
  const conflicts = nearby.filter(p => bad.some(b => p.name.includes(b) || b.includes(p.name)));
  const benefits  = nearby.filter(p => good.some(g => p.name.includes(g) || g.includes(p.name)));
  return { conflicts, benefits };
}

// â”€â”€ Render all placed objects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderObjects() {
  document.querySelectorAll('.bed-obj, .plant-obj').forEach(el => el.remove());
  const vp = document.getElementById('viewport');

  // Beds
  bedData.forEach(bed => {
    const el = document.createElement('div');
    el.className = `bed-obj bed-${bed.type}`;
    el.id = `bed-${bed.id}`;
    // Clamp position
    const cx = Math.max(0, Math.min(VP_W - bed.w, bed.x));
    const cy = Math.max(0, Math.min(VP_H - bed.h, bed.y));
    bed.x = cx; bed.y = cy;
    el.style.cssText = `left:${cx}px;top:${cy}px;width:${bed.w}px;height:${bed.h}px;`;
    el.textContent = bed.type;
    el.draggable = true;
    el.ondragstart = e => { e.stopPropagation(); dragExisting(e, 'bed', bed.id); };
    el.oncontextmenu = e => { e.preventDefault(); openCtx(e, 'bed', bed.id); };

    // Resize handle
    const rh = document.createElement('div');
    rh.className = 'resize-handle';
    rh.onmousedown = e => startResize(e, bed);
    el.appendChild(rh);
    vp.appendChild(el);
  });

  // Plants
  plantData.forEach(plant => {
    const age = simDay - 120;
    const growth = Math.max(0, Math.min(1, age / Math.max(1, plant.dtm)));
    const blooming = simDay >= plant.bloomStart && simDay <= plant.bloomStart + 40;
    const { conflicts, benefits } = layers.companion ? getConflictsForPlant(plant) : { conflicts:[], benefits:[] };
    const hasConflict = conflicts.length > 0;

    // Clamp position
    plant.x = Math.max(CELL/2, Math.min(VP_W - CELL/2, plant.x));
    plant.y = Math.max(CELL/2, Math.min(VP_H - CELL/2, plant.y));

    const el = document.createElement('div');
    el.className = `plant-obj${blooming ? ' stage-bloom' : ''}${hasConflict && layers.companion ? ' companion-conflict' : ''}${plant.isNative ? ' native-marker' : plant.isHost ? ' host-marker' : ''}`;
    el.id = `plant-${plant.id}`;

    const scale = age < -5 ? 0 : (0.25 + growth * 0.75);
    const sz = Math.round(36 * scale);
    el.style.cssText = `left:${plant.x - sz/2}px;top:${plant.y - sz/2}px;width:${sz}px;height:${sz}px;font-size:${Math.round(22*scale)}px;opacity:${age < -5 ? 0 : 1}`;

    el.textContent = plant.emoji || 'ğŸŒ±';
    el.draggable = true;
    el.ondragstart = e => { e.stopPropagation(); dragExisting(e, 'plant', plant.id); };
    el.oncontextmenu = e => { e.preventDefault(); openCtx(e, 'plant', plant.id); };

    // Spread ring
    if (layers.spread && plant.spread > 0) {
      const ring = document.createElement('div');
      const px = (plant.spread / 12) * CELL; // inches â†’ px (1 CELL = 1 ft)
      ring.className = `spread-ring${hasConflict && layers.companion ? ' conflict' : ''}`;
      ring.style.cssText = `width:${px}px;height:${px}px;`;
      el.appendChild(ring);
    }

    // Tooltip
    const tip = document.createElement('div');
    tip.className = 'plant-tooltip';
    const maturity = age <= 0 ? 'Not planted yet' : age >= plant.dtm ? 'âœ“ Mature' : `${Math.round((age/plant.dtm)*100)}% grown`;
    const compLine = hasConflict ? `âš ï¸ Conflict: ${conflicts.map(c=>c.name).join(', ')}` :
                     benefits.length ? `âœ“ Good: ${benefits.map(b=>b.name).join(', ')}` : '';
    tip.innerHTML = `<b>${plant.name}</b><br/>${maturity}${plant.isNative ? ' Â· NATIVE':plant.isHost?' Â· HOST':''}${compLine ? '<br/>'+compLine : ''}`;
    el.appendChild(tip);

    vp.appendChild(el);
  });
}

// â”€â”€ Full render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderLayers();
  renderObjects();
  updateInsights();
}

// â”€â”€ Insights panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateInsights() {
  const heavyFeeders = plantData.filter(p => HEAVY_FEEDERS.has(p.family)).length;
  const nFixers      = plantData.filter(p => N_FIXERS.has(p.family)).length;
  let nitrogen = Math.max(0, 100 - (heavyFeeders * 10) + (nFixers * 5));
  const rotationConflicts = rotationYear > 2026 ? plantData.filter(p => HEAVY_FEEDERS.has(p.family)).length : 0;

  const nEl = document.getElementById('kv-nitrogen');
  nEl.textContent = nitrogen >= 75 ? 'Optimal' : nitrogen >= 40 ? 'Moderate' : 'Depleted';
  nEl.className   = `kv-val ${nitrogen >= 75 ? 'good' : nitrogen >= 40 ? 'warn' : 'danger'}`;

  document.getElementById('kv-rotation').textContent = rotationConflicts;
  document.getElementById('kv-rotation').className   = `kv-val ${rotationConflicts > 0 ? 'danger' : 'good'}`;
  document.getElementById('kv-soil').textContent     = `${Math.min(100,nitrogen+5)}%`;
  document.getElementById('kv-plants').textContent   = plantData.length;
  document.getElementById('kv-beds').textContent     = bedData.length;
  document.getElementById('kv-pollinators').textContent = `${plantData.filter(p=>p.isNative||p.isHost).length} native/host`;

  const pestRisk = healthScans.length > 0 ? 'High' : plantData.filter(p=>p.name==='Tomato').length > 3 ? 'Medium' : 'Low';
  const pestEl = document.getElementById('kv-pest');
  pestEl.textContent = pestRisk;
  pestEl.className   = `kv-val ${pestRisk==='High'?'danger':pestRisk==='Medium'?'warn':'good'}`;

  // Companion alerts panel
  const allConflicts = [];
  if (layers.companion) {
    plantData.forEach(p => {
      const { conflicts } = getConflictsForPlant(p);
      conflicts.forEach(c => allConflicts.push(`${p.name} â†” ${c.name}`));
    });
  }
  const alertEl = document.getElementById('alert-panel');
  if (allConflicts.length > 0) {
    const unique = [...new Set(allConflicts.map(a => a.split(' â†” ').sort().join(' â†” ')))];
    alertEl.style.display = 'block';
    alertEl.className = 'companion';
    alertEl.innerHTML = `<b>âš ï¸ Companion Conflicts</b><br/>${unique.join('<br/>')}`;
  } else if (rotationConflicts > 0) {
    alertEl.style.display = 'block';
    alertEl.className = '';
    alertEl.innerHTML = `<b>ğŸ”„ Rotation Alert</b><br/>${rotationConflicts} plant(s) may conflict with ${rotationYear} soil history.`;
  } else {
    alertEl.style.display = 'none';
  }
}

// â”€â”€ Season scrubber â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onScrub() {
  simDay = parseInt(document.getElementById('time-scrubber').value);
  const date = new Date(2026, 0, simDay);
  document.getElementById('pulse-date').textContent =
    date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  const seasons = [[60,'Early Spring'],[120,'Spring'],[152,'Late Spring'],[182,'Summer'],[244,'Late Summer'],[274,'Fall'],[305,'Late Fall'],[335,'Winter']];
  const s = seasons.slice().reverse().find(([d]) => simDay >= d);
  document.getElementById('season-badge').textContent = s ? s[1] : 'Winter';
  renderAll();
}

// â”€â”€ Drag helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _drag = {};

function dragBed(e, type, w, h) {
  _drag = { kind:'bed', isNew:true, type, w, h };
  e.dataTransfer.effectAllowed = 'copy';
}
function dragPlant(e, plant) {
  _drag = { kind:'plant', isNew:true, plant };
  e.dataTransfer.effectAllowed = 'copy';
}
function dragExisting(e, kind, id) {
  const rect = e.currentTarget.getBoundingClientRect();
  _drag = { kind, isNew:false, id, offX: e.clientX - rect.left, offY: e.clientY - rect.top };
  e.dataTransfer.effectAllowed = 'move';
}

function onViewportDrop(e) {
  e.preventDefault();
  const vp = document.getElementById('viewport');
  const rect = vp.getBoundingClientRect();
  const rawX = e.clientX - rect.left;
  const rawY = e.clientY - rect.top;

  if (_drag.kind === 'bed') {
    if (_drag.isNew) {
      const x = Math.max(0, Math.min(VP_W - _drag.w, rawX - _drag.w/2));
      const y = Math.max(0, Math.min(VP_H - _drag.h, rawY - _drag.h/2));
      bedData.push({ id: uid(), type: _drag.type, x, y, w: _drag.w, h: _drag.h });
    } else {
      const bed = bedData.find(b => b.id === _drag.id);
      if (bed) {
        bed.x = Math.max(0, Math.min(VP_W - bed.w, rawX - (_drag.offX||bed.w/2)));
        bed.y = Math.max(0, Math.min(VP_H - bed.h, rawY - (_drag.offY||bed.h/2)));
      }
    }
  } else if (_drag.kind === 'plant') {
    if (_drag.isNew) {
      const p = _drag.plant;
      const x = Math.max(CELL/2, Math.min(VP_W - CELL/2, rawX));
      const y = Math.max(CELL/2, Math.min(VP_H - CELL/2, rawY));
      plantData.push({ id: uid(), libId: p.libId, name: p.name, emoji: p.emoji,
        family: p.family, spread: p.spread, dtm: p.dtm, bloomStart: p.bloomStart,
        isNative: p.isNative, isHost: p.isHost, x, y });
    } else {
      const plant = plantData.find(p => p.id === _drag.id);
      if (plant) {
        plant.x = Math.max(CELL/2, Math.min(VP_W - CELL/2, rawX - (_drag.offX||0)));
        plant.y = Math.max(CELL/2, Math.min(VP_H - CELL/2, rawY - (_drag.offY||0)));
      }
    }
  }
  scheduleSave();
  renderAll();
}

// â”€â”€ Trash drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTrashDrop(e) {
  e.preventDefault();
  document.getElementById('trash-bin').classList.remove('drag-over');
  if (!_drag.id) return;
  if (_drag.kind === 'bed')   bedData   = bedData.filter(b => b.id !== _drag.id);
  if (_drag.kind === 'plant') plantData = plantData.filter(p => p.id !== _drag.id);
  scheduleSave();
  renderAll();
}

// â”€â”€ Cell click (tactical tags) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onCellClick(cellId) {
  if (!activeTactic) return;
  if (!cellTags[cellId]) cellTags[cellId] = new Set();
  if (cellTags[cellId].has(activeTactic)) cellTags[cellId].delete(activeTactic);
  else cellTags[cellId].add(activeTactic);
  renderAll();
}

// Hover â€” show nearby companion info
function onCellHover(cellId) {
  if (!layers.companion) return;
  const nearby = plantsNearCell(cellId, CELL * 2);
  // subtle highlight handled by CSS :hover
}

// â”€â”€ Tactical mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTactic(t) {
  activeTactic = activeTactic === t ? null : t;
  document.querySelectorAll('.tactic-btn').forEach(b => {
    b.className = 'tactic-btn';
    const id = b.id.replace('btn-','');
    if (id === activeTactic) b.classList.add(`active-${id}`);
  });
}

// â”€â”€ Year / rotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setYear(y) {
  rotationYear = y;
  ['rot-2026','rot-2027','rot-2028'].forEach(id => {
    const yr = parseInt(id.split('-')[1]);
    document.getElementById(id).className = `year-btn${yr === y ? ' active' : ''}`;
  });
  renderAll();
}

// â”€â”€ Layer toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleLayer(name) {
  layers[name] = !layers[name];
  const row = document.getElementById(`layer-${name}`);
  if (layers[name]) row.classList.add('on');
  else              row.classList.remove('on');
  renderAll();
}

// Initialize default-on layers visually
function syncLayerUI() {
  Object.entries(layers).forEach(([name, on]) => {
    const row = document.getElementById(`layer-${name}`);
    if (on)  row?.classList.add('on');
    else     row?.classList.remove('on');
  });
}

// â”€â”€ Bed resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startResize(e, bed) {
  e.stopPropagation();
  e.preventDefault();
  const startX = e.clientX, startY = e.clientY;
  const startW = bed.w, startH = bed.h;

  function onMove(ev) {
    bed.w = Math.max(48, Math.min(VP_W - bed.x, startW + ev.clientX - startX));
    bed.h = Math.max(24, Math.min(VP_H - bed.y, startH + ev.clientY - startY));
    // Live update just the element for perf
    const el = document.getElementById(`bed-${bed.id}`);
    if (el) { el.style.width = bed.w + 'px'; el.style.height = bed.h + 'px'; }
  }
  function onUp() {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    scheduleSave();
    renderAll();
  }
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

// â”€â”€ Context menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCtx(e, kind, id) {
  ctxTarget = { kind, id };
  const menu = document.getElementById('ctx-menu');
  menu.style.display = 'block';
  // Keep in viewport
  const mx = Math.min(e.clientX, window.innerWidth - 160);
  const my = Math.min(e.clientY, window.innerHeight - 120);
  menu.style.left = mx + 'px';
  menu.style.top  = my + 'px';
}
document.addEventListener('click', () => { document.getElementById('ctx-menu').style.display = 'none'; });

document.getElementById('ctx-delete').onclick = () => {
  if (!ctxTarget) return;
  if (ctxTarget.kind === 'bed')   bedData   = bedData.filter(b => b.id !== ctxTarget.id);
  if (ctxTarget.kind === 'plant') plantData = plantData.filter(p => p.id !== ctxTarget.id);
  scheduleSave(); renderAll();
};
document.getElementById('ctx-clone').onclick = () => {
  if (!ctxTarget) return;
  if (ctxTarget.kind === 'plant') {
    const orig = plantData.find(p => p.id === ctxTarget.id);
    if (orig) { plantData.push({ ...orig, id: uid(), x: orig.x + CELL, y: orig.y + CELL }); }
  }
  if (ctxTarget.kind === 'bed') {
    const orig = bedData.find(b => b.id === ctxTarget.id);
    if (orig) { bedData.push({ ...orig, id: uid(), x: orig.x + 20, y: orig.y + 20 }); }
  }
  scheduleSave(); renderAll();
};
document.getElementById('ctx-info').onclick = () => {
  if (!ctxTarget || ctxTarget.kind !== 'plant') return;
  const p = plantData.find(pl => pl.id === ctxTarget.id);
  if (!p) return;
  const age = simDay - 120;
  const mat = age <= 0 ? 'Not yet growing' : age >= p.dtm ? 'Fully mature' : `${Math.round((age/p.dtm)*100)}%`;
  showAlert(`${p.emoji} ${p.name} â€” ${mat} Â· ${p.isNative?'Native ':''}${p.isHost?'Host ':''} Â· Family: ${p.family||'Unknown'}`, 'info');
};

// â”€â”€ Alert helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAlert(msg, type='') {
  const el = document.getElementById('alert-panel');
  el.style.display = 'block';
  el.className = type;
  el.innerHTML = msg;
  setTimeout(() => { if (el.innerHTML === msg) el.style.display = 'none'; }, 4000);
}

// â”€â”€ Persistence (Supabase) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleSave() {
  isDirty = true;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveState, 1200);
}

async function saveState() {
  if (!userId) return;
  const state = {
    user_id:    userId,
    bed_data:   JSON.stringify(bedData),
    plant_data: JSON.stringify(plantData),
    cell_tags:  JSON.stringify(Object.fromEntries(Object.entries(cellTags).map(([k,v])=>[k,[...v]]))),
    updated_at: new Date().toISOString(),
  };
  const { error } = await sb.from('map_state').upsert(state, { onConflict: 'user_id' });
  if (!error) {
    const ind = document.getElementById('save-indicator');
    ind.classList.add('show');
    setTimeout(() => ind.classList.remove('show'), 1500);
  }
  isDirty = false;
}

async function loadState() {
  if (!userId) return;
  const { data } = await sb.from('map_state').select('*').eq('user_id', userId).single();
  if (!data) return;
  try {
    bedData   = JSON.parse(data.bed_data   || '[]');
    plantData = JSON.parse(data.plant_data || '[]');
    const rawTags = JSON.parse(data.cell_tags || '{}');
    cellTags = Object.fromEntries(Object.entries(rawTags).map(([k,v])=>[k, new Set(v)]));
  } catch(e) { console.warn('[MapSync] State parse error:', e); }
  renderAll();
}

// â”€â”€ Load health scans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHealthScans() {
  const { data } = await sb.from('plant_health_scans')
    .select('*')
    .neq('status','resolved')
    .order('scan_date', { ascending: false });
  healthScans = data || [];
}

// â”€â”€ Load plant inventory from garden_library â”€â”€
async function loadInventory() {
  const { data, error } = await sb.from('garden_library')
    .select('id, common_name, emoji, plant_family, spread_in, maturity_days, bloom_start_day, is_native, is_host_plant')
    .order('common_name');

  const grid = document.getElementById('plant-inventory');

  if (error || !data || data.length === 0) {
    // Fallback hardcoded plants if library is empty or table has different schema
    const fallback = [
      { id:'t1', common_name:'Tomato',   emoji:'ğŸ…', plant_family:'Solanaceae',  spread_in:24, maturity_days:75, bloom_start_day:130, is_native:false, is_host_plant:false },
      { id:'z1', common_name:'Zinnia',   emoji:'ğŸŒ¸', plant_family:'Asteraceae',  spread_in:12, maturity_days:60, bloom_start_day:130, is_native:false, is_host_plant:true  },
      { id:'m1', common_name:'Marigold', emoji:'ğŸŒ¼', plant_family:'Asteraceae',  spread_in:12, maturity_days:50, bloom_start_day:120, is_native:false, is_host_plant:true  },
      { id:'b1', common_name:'Bean',     emoji:'ğŸ«˜', plant_family:'Fabaceae',    spread_in:8,  maturity_days:55, bloom_start_day:140, is_native:false, is_host_plant:false },
      { id:'c1', common_name:'Carrot',   emoji:'ğŸ¥•', plant_family:'Apiaceae',    spread_in:4,  maturity_days:70, bloom_start_day:999, is_native:false, is_host_plant:false },
      { id:'s1', common_name:'Squash',   emoji:'ğŸ¥’', plant_family:'Cucurbitaceae',spread_in:36,maturity_days:60, bloom_start_day:135, is_native:false, is_host_plant:false },
      { id:'p1', common_name:'Purple Coneflower', emoji:'ğŸŒº', plant_family:'Asteraceae', spread_in:18, maturity_days:365, bloom_start_day:170, is_native:true, is_host_plant:true },
      { id:'o1', common_name:'Milkweed', emoji:'ğŸŒ¿', plant_family:'Apocynaceae', spread_in:24, maturity_days:365, bloom_start_day:160, is_native:true, is_host_plant:true },
    ];
    renderInventory(grid, fallback);
    return;
  }

  renderInventory(grid, data);
}

function renderInventory(grid, plants) {
  grid.innerHTML = plants.map(p => {
    const badges = [];
    if (p.is_native)     badges.push('<span class="badge badge-native">N</span>');
    if (p.is_host_plant) badges.push('<span class="badge badge-host">H</span>');
    const plant = {
      libId: p.id, name: p.common_name, emoji: p.emoji || 'ğŸŒ±',
      family: p.plant_family || 'Unknown', spread: p.spread_in || 12,
      dtm: p.maturity_days || 60, bloomStart: p.bloom_start_day || 150,
      isNative: p.is_native, isHost: p.is_host_plant,
    };
    return `<div class="inv-item" draggable="true"
      ondragstart="dragPlant(event, ${JSON.stringify(JSON.stringify(plant)).replace(/"/g,'&quot;')})">
      ${p.emoji||'ğŸŒ±'} ${p.common_name} ${badges.join('')}
    </div>`;
  }).join('');

  // Re-attach proper drag handlers
  grid.querySelectorAll('.inv-item').forEach((el, i) => {
    const p = plants[i];
    const plant = {
      libId: p.id, name: p.common_name, emoji: p.emoji || 'ğŸŒ±',
      family: p.plant_family || 'Unknown', spread: p.spread_in || 12,
      dtm: p.maturity_days || 60, bloomStart: p.bloom_start_day || 150,
      isNative: p.is_native, isHost: p.is_host_plant,
    };
    el.ondragstart = e => { dragPlant(e, plant); };
  });
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-login').onclick = async () => {
  const email = document.getElementById('a-email').value.trim();
  const pass  = document.getElementById('a-pass').value;
  document.getElementById('auth-err').textContent = '';
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { document.getElementById('auth-err').textContent = error.message; return; }
  afterAuth();
};
document.getElementById('btn-reg').onclick = async () => {
  const email = document.getElementById('a-email').value.trim();
  const pass  = document.getElementById('a-pass').value;
  const { error } = await sb.auth.signUp({ email, password: pass });
  if (error) { document.getElementById('auth-err').textContent = error.message; }
  else { document.getElementById('auth-err').style.color='var(--green)'; document.getElementById('auth-err').textContent = 'Check your email to confirm.'; }
};

async function afterAuth() {
  const { data: { user } } = await sb.auth.getUser();
  if (!user) return;
  userId = user.id;
  document.getElementById('auth-overlay').classList.add('hidden');
  await Promise.all([loadState(), loadHealthScans(), loadInventory()]);
  renderAll();
}

async function checkSession() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) afterAuth();
}

// â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid() { return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  createGrid();
  syncLayerUI();
  onScrub();
  checkSession();
});
</script>
</body>
</html>
