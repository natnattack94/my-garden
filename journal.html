<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GardenHub OS | Garden Journal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:        #f7f3ec;
  --page:      #fdfaf5;
  --page2:     #f5f0e8;
  --border:    #d8ccb4;
  --border2:   #c4b898;
  --ink:       #1a160e;
  --ink2:      #3a3020;
  --muted:     #8a7a60;
  --faint:     #b8a880;
  --forest:    #2a5028;
  --forest-lt: #3d7038;
  --forest-pale: rgba(42,80,40,0.08);
  --red-rule:  #b83030;
  --gold:      #8a6a20;
  --gold-lt:   #c49a30;
  --amber:     #c07030;
  --blue-ink:  #1a3050;
  --shadow:    rgba(60,40,10,0.12);

  --serif:     'Lora', Georgia, serif;
  --mono:      'DM Mono', monospace;
  --sans:      'DM Sans', sans-serif;

  --mood-thriving:    #2a6030;
  --mood-hopeful:     #2a5080;
  --mood-concerned:   #804020;
  --mood-observing:   #605020;
  --mood-celebratory: #702060;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: var(--serif);
  min-height: 100vh;
}

/* Subtle ruled-paper texture on body */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image: repeating-linear-gradient(
    transparent, transparent 27px,
    rgba(180,160,120,0.13) 27px, rgba(180,160,120,0.13) 28px
  );
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.top-bar {
  position: sticky; top: 0; z-index: 200;
  background: var(--forest);
  border-bottom: 3px solid var(--forest-lt);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.7rem 1.75rem; gap: 1rem;
}
.logo-block { display: flex; align-items: baseline; gap: 0.75rem; }
.logo-eye  { font-family: var(--mono); font-size: 0.48rem; color: rgba(255,255,255,0.4); letter-spacing: 0.22em; text-transform: uppercase; }
.logo-name { font-family: var(--serif); font-size: 1.1rem; color: #d8ead0; font-style: italic; }
.logo-name em { color: #a0d890; }

nav { display: flex; gap: 0.35rem; flex-wrap: wrap; align-items: center; }
.nav-link {
  font-family: var(--mono); font-size: 0.52rem; letter-spacing: 0.07em; text-transform: uppercase;
  text-decoration: none; padding: 0.28rem 0.55rem;
  border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.5);
  background: transparent; cursor: pointer; transition: all 0.15s;
}
.nav-link:hover  { border-color: rgba(255,255,255,0.35); color: rgba(255,255,255,0.85); }
.nav-link.active { border-color: #a0d890; color: #a0d890; }
.nav-link.danger:hover { border-color: #f08080; color: #f08080; }

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout {
  display: flex;
  position: relative; z-index: 1;
  min-height: calc(100vh - 48px);
}

/* â”€â”€ Sidebar / Filter panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 220px; min-width: 220px;
  background: var(--page2);
  border-right: 1px solid var(--border);
  padding: 1.5rem 1rem;
  position: sticky; top: 48px;
  height: calc(100vh - 48px);
  overflow-y: auto;
  display: flex; flex-direction: column; gap: 1.25rem;
}
.sb-section { display: flex; flex-direction: column; gap: 0.5rem; }
.sb-label {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.2em;
  text-transform: uppercase; color: var(--muted);
  border-bottom: 1px solid var(--border); padding-bottom: 0.3rem;
}
.sb-search {
  width: 100%; border: 1px solid var(--border); background: var(--page);
  color: var(--ink); padding: 0.45rem 0.6rem;
  font-family: var(--serif); font-size: 0.75rem; outline: none;
  transition: border-color 0.15s;
}
.sb-search:focus { border-color: var(--forest); }
.sb-search::placeholder { color: var(--faint); }

.filter-chip {
  display: flex; align-items: center; gap: 0.4rem;
  font-family: var(--mono); font-size: 0.52rem; letter-spacing: 0.06em;
  padding: 0.3rem 0.55rem; border: 1px solid var(--border);
  cursor: pointer; color: var(--muted); background: transparent;
  transition: all 0.15s; text-transform: uppercase; user-select: none;
}
.filter-chip:hover { border-color: var(--forest); color: var(--forest); }
.filter-chip.on { background: var(--forest-pale); border-color: var(--forest); color: var(--forest); }
.chip-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

.sb-select {
  width: 100%; border: 1px solid var(--border); background: var(--page);
  color: var(--ink); padding: 0.4rem 0.55rem;
  font-family: var(--mono); font-size: 0.6rem; outline: none;
  cursor: pointer;
}
.sb-select:focus { border-color: var(--forest); }

.new-entry-btn {
  width: 100%; padding: 0.65rem; margin-top: auto;
  background: var(--forest); color: #d8ead0;
  border: none; cursor: pointer;
  font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase;
  transition: background 0.15s;
}
.new-entry-btn:hover { background: var(--forest-lt); }

/* â”€â”€ Main content area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  flex: 1;
  padding: 2rem 2.5rem 6rem;
  max-width: 820px;
}

/* Page title */
.journal-header {
  margin-bottom: 2rem;
  padding-bottom: 1.25rem;
  border-bottom: 2px solid var(--border);
  display: flex; align-items: flex-end; justify-content: space-between; gap: 1rem;
}
.journal-title {
  font-family: var(--serif); font-size: 2.8rem; font-weight: 600;
  font-style: italic; color: var(--ink); line-height: 1;
}
.journal-title em { color: var(--forest); }
.journal-meta {
  font-family: var(--mono); font-size: 0.52rem; color: var(--muted);
  letter-spacing: 0.12em; text-transform: uppercase;
  text-align: right; line-height: 1.8;
}

/* â”€â”€ Month group headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.month-group { margin-bottom: 2.5rem; }
.month-marker {
  display: flex; align-items: center; gap: 1rem;
  margin-bottom: 1.25rem; position: relative;
}
.month-marker::before {
  content: '';
  position: absolute; left: -2.5rem; top: 50%;
  width: 2.5rem; height: 1px; background: var(--border2);
}
.month-name {
  font-family: var(--serif); font-size: 1.4rem; font-style: italic;
  color: var(--forest); font-weight: 500;
}
.month-count {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.15em;
  color: var(--muted); text-transform: uppercase;
}

/* â”€â”€ Entry cards (torn notebook pages) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.entry-card {
  background: var(--page);
  border: 1px solid var(--border);
  border-left: 4px solid var(--red-rule);
  margin-bottom: 1.25rem;
  position: relative;
  box-shadow: 2px 3px 10px var(--shadow);
  animation: pageIn 0.3s ease both;
  cursor: pointer;
  transition: box-shadow 0.2s, transform 0.15s;
}
.entry-card:hover {
  box-shadow: 3px 5px 18px var(--shadow);
  transform: translateY(-1px);
}

/* Torn top edge effect */
.entry-card::before {
  content: '';
  position: absolute; top: -2px; left: 0; right: 0; height: 3px;
  background: repeating-linear-gradient(
    90deg,
    var(--page) 0px, var(--page) 3px,
    var(--bg) 3px, var(--bg) 4px,
    var(--page) 4px, var(--page) 7px,
    var(--bg) 7px, var(--bg) 9px
  );
}

/* Ring holes on left */
.entry-card::after {
  content: 'â—¦ â—¦ â—¦';
  position: absolute; left: -18px; top: 50%; transform: translateY(-50%);
  font-size: 0.55rem; color: var(--border2); line-height: 2; writing-mode: vertical-lr;
  letter-spacing: 0.5rem;
}

@keyframes pageIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

.entry-inner { padding: 1.1rem 1.25rem 1rem; }

.entry-dateline {
  display: flex; align-items: center; gap: 0.75rem;
  margin-bottom: 0.6rem; flex-wrap: wrap;
}
.entry-date {
  font-family: var(--mono); font-size: 0.58rem; color: var(--muted);
  letter-spacing: 0.1em; text-transform: uppercase;
}
.entry-mood {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.12em;
  text-transform: uppercase; padding: 0.1rem 0.45rem;
  border: 1px solid; border-radius: 0;
}
.mood-thriving    { color: var(--mood-thriving);    border-color: var(--mood-thriving);    background: rgba(42,96,48,0.06); }
.mood-hopeful     { color: var(--mood-hopeful);     border-color: var(--mood-hopeful);     background: rgba(42,80,128,0.06); }
.mood-concerned   { color: var(--mood-concerned);   border-color: var(--mood-concerned);   background: rgba(128,64,32,0.06); }
.mood-observing   { color: var(--mood-observing);   border-color: var(--mood-observing);   background: rgba(96,80,32,0.06); }
.mood-celebratory { color: var(--mood-celebratory); border-color: var(--mood-celebratory); background: rgba(112,32,96,0.06); }

.entry-weather {
  font-family: var(--mono); font-size: 0.52rem; color: var(--faint);
}

.entry-title {
  font-family: var(--serif); font-size: 1.2rem; font-weight: 600;
  color: var(--ink); margin-bottom: 0.4rem; line-height: 1.3;
}
.entry-title:empty { display: none; }

.entry-body {
  font-family: var(--serif); font-size: 0.88rem; color: var(--ink2);
  line-height: 1.75; overflow: hidden;
}
.entry-body.collapsed { max-height: 4.5em; -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }

.entry-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.5rem 1.25rem 0.6rem; flex-wrap: wrap; gap: 0.4rem;
  border-top: 1px solid var(--border); margin-top: 0.75rem;
}
.entry-tags { display: flex; gap: 0.35rem; flex-wrap: wrap; }
.entry-tag {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.08em;
  padding: 0.15rem 0.4rem; border: 1px solid var(--border2);
  color: var(--muted); text-transform: uppercase;
}
.entry-plant-tag {
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.06em;
  padding: 0.15rem 0.4rem; border: 1px solid var(--forest);
  color: var(--forest); text-transform: uppercase;
  background: var(--forest-pale);
}
.entry-actions { display: flex; gap: 0.4rem; }
.entry-btn {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.08em; text-transform: uppercase;
  padding: 0.2rem 0.5rem; border: 1px solid var(--border); color: var(--muted);
  background: transparent; cursor: pointer; transition: all 0.15s;
}
.entry-btn:hover { border-color: var(--forest); color: var(--forest); }
.entry-btn.del:hover { border-color: var(--red-rule); color: var(--red-rule); }
.entry-word-count { font-family: var(--mono); font-size: 0.48rem; color: var(--faint); }

/* Photo thumbnail */
.entry-photo {
  width: 100%; max-height: 260px; object-fit: cover;
  display: block; margin-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-journal {
  text-align: center; padding: 5rem 2rem;
  font-family: var(--serif); color: var(--muted);
}
.empty-journal .big { font-size: 3rem; margin-bottom: 1rem; }
.empty-journal p { font-size: 1rem; font-style: italic; line-height: 1.8; }

/* â”€â”€ COMPOSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#composer-overlay {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(20,15,8,0.55);
  display: flex; align-items: flex-start; justify-content: flex-end;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
#composer-overlay.open { opacity: 1; pointer-events: all; }

.composer-panel {
  width: min(680px, 100vw);
  height: 100vh; background: var(--page);
  border-left: 3px solid var(--forest);
  display: flex; flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  overflow: hidden;
}
#composer-overlay.open .composer-panel { transform: translateX(0); }

.composer-top {
  background: var(--forest); padding: 0.85rem 1.25rem;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.composer-heading {
  font-family: var(--serif); font-size: 1rem; font-style: italic;
  color: #d8ead0;
}
.composer-close {
  background: none; border: none; color: rgba(255,255,255,0.5);
  cursor: pointer; font-size: 1.1rem; transition: color 0.15s; padding: 0;
}
.composer-close:hover { color: white; }

.composer-body {
  flex: 1; overflow-y: auto; padding: 1.5rem;
  display: flex; flex-direction: column; gap: 1rem;
}

/* Composer field groups */
.cf-row { display: flex; gap: 0.75rem; align-items: flex-start; flex-wrap: wrap; }
.cf-group { display: flex; flex-direction: column; gap: 0.3rem; flex: 1; min-width: 140px; }
.cf-label {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.15em;
  text-transform: uppercase; color: var(--muted);
}
.cf-input, .cf-select, .cf-textarea {
  border: 1px solid var(--border); background: var(--bg);
  color: var(--ink); padding: 0.5rem 0.65rem;
  font-family: var(--serif); font-size: 0.85rem; outline: none;
  transition: border-color 0.15s; width: 100%;
}
.cf-input:focus, .cf-select:focus, .cf-textarea:focus { border-color: var(--forest); }
.cf-input::placeholder, .cf-textarea::placeholder { color: var(--faint); font-style: italic; }
.cf-textarea { resize: vertical; min-height: 220px; line-height: 1.8; }
.cf-select { font-family: var(--mono); font-size: 0.7rem; cursor: pointer; }

/* Plant tag pills in composer */
.plant-picker { display: flex; flex-wrap: wrap; gap: 0.35rem; }
.plant-pill {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em; text-transform: uppercase;
  padding: 0.25rem 0.55rem; border: 1px solid var(--border);
  cursor: pointer; color: var(--muted); user-select: none; transition: all 0.12s;
}
.plant-pill:hover { border-color: var(--forest); color: var(--forest); }
.plant-pill.sel   { background: var(--forest-pale); border-color: var(--forest); color: var(--forest); }

/* Custom tag input */
.tag-input-wrap { display: flex; gap: 0.4rem; }
.tag-input {
  flex: 1; border: 1px solid var(--border); background: var(--bg);
  color: var(--ink); padding: 0.4rem 0.6rem;
  font-family: var(--mono); font-size: 0.65rem; outline: none;
}
.tag-input:focus { border-color: var(--forest); }
.tag-add-btn {
  padding: 0.4rem 0.65rem; background: transparent;
  border: 1px solid var(--border); color: var(--muted);
  font-family: var(--mono); font-size: 0.6rem; cursor: pointer; transition: all 0.15s;
}
.tag-add-btn:hover { border-color: var(--forest); color: var(--forest); }
.tags-display { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.35rem; }
.tag-badge {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em; text-transform: uppercase;
  padding: 0.18rem 0.45rem; border: 1px solid var(--border2); color: var(--muted);
  display: flex; align-items: center; gap: 0.3rem;
}
.tag-remove { cursor: pointer; opacity: 0.6; }
.tag-remove:hover { opacity: 1; color: var(--red-rule); }

/* Photo upload area */
.photo-drop {
  border: 2px dashed var(--border); padding: 1.5rem;
  text-align: center; cursor: pointer; transition: border-color 0.15s;
  position: relative;
}
.photo-drop:hover { border-color: var(--forest); }
.photo-drop.has-photo { padding: 0; border-style: solid; }
.photo-drop input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; }
.photo-drop-label {
  font-family: var(--mono); font-size: 0.58rem; color: var(--muted);
  pointer-events: none; letter-spacing: 0.08em;
}
.photo-preview { width: 100%; max-height: 200px; object-fit: cover; display: block; }
.photo-clear {
  position: absolute; top: 0.4rem; right: 0.4rem;
  background: rgba(255,255,255,0.85); border: 1px solid var(--border);
  color: var(--muted); padding: 0.2rem 0.4rem;
  font-family: var(--mono); font-size: 0.5rem; cursor: pointer;
}

/* Weather auto-fill */
.weather-autofill {
  display: flex; align-items: center; gap: 0.5rem;
  font-family: var(--mono); font-size: 0.55rem; color: var(--muted);
}
.weather-pill {
  padding: 0.2rem 0.5rem; border: 1px solid var(--border);
  color: var(--forest); font-size: 0.55rem; background: var(--forest-pale);
}

/* Word count display in composer */
.wc-display {
  font-family: var(--mono); font-size: 0.5rem; color: var(--faint);
  text-align: right;
}

/* Composer footer */
.composer-footer {
  padding: 0.85rem 1.25rem; border-top: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;
  flex-shrink: 0; background: var(--page2);
}
.save-btn {
  padding: 0.55rem 1.5rem; background: var(--forest); color: #d8ead0;
  border: none; cursor: pointer;
  font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase;
  transition: background 0.15s;
}
.save-btn:hover { background: var(--forest-lt); }
.save-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.draft-status {
  font-family: var(--mono); font-size: 0.52rem; color: var(--faint);
  letter-spacing: 0.08em;
}

/* â”€â”€ Full-read overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#reader-overlay {
  position: fixed; inset: 0; z-index: 250;
  background: rgba(20,15,8,0.7);
  display: flex; align-items: center; justify-content: center; padding: 2rem;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
#reader-overlay.open { opacity: 1; pointer-events: all; }
.reader-panel {
  background: var(--page);
  border: 1px solid var(--border);
  border-left: 5px solid var(--red-rule);
  max-width: 660px; width: 100%; max-height: 90vh;
  overflow-y: auto; padding: 2.5rem 2rem 2rem;
  transform: scale(0.97); transition: transform 0.2s;
  box-shadow: 4px 8px 40px rgba(30,15,0,0.3);
  position: relative;
}
#reader-overlay.open .reader-panel { transform: scale(1); }
.reader-close {
  position: absolute; top: 0.75rem; right: 0.85rem;
  background: none; border: none; color: var(--muted);
  cursor: pointer; font-size: 1rem; transition: color 0.15s;
}
.reader-close:hover { color: var(--ink); }
.reader-date { font-family: var(--mono); font-size: 0.55rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 0.5rem; }
.reader-title { font-family: var(--serif); font-size: 1.8rem; font-weight: 600; font-style: italic; color: var(--ink); margin-bottom: 1rem; line-height: 1.2; }
.reader-body  { font-family: var(--serif); font-size: 0.95rem; color: var(--ink2); line-height: 1.85; white-space: pre-wrap; }
.reader-photo { width: 100%; max-height: 340px; object-fit: cover; margin-bottom: 1.25rem; }
.reader-footer { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center; }

/* â”€â”€ Delete confirm dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#confirm-dialog {
  position: fixed; inset: 0; z-index: 400;
  background: rgba(20,15,8,0.6);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
#confirm-dialog.open { opacity: 1; pointer-events: all; }
.confirm-box {
  background: var(--page); border: 1px solid var(--border);
  border-top: 3px solid var(--red-rule); padding: 1.5rem 1.75rem;
  max-width: 360px; width: 90%;
}
.confirm-title { font-family: var(--serif); font-size: 1.1rem; font-style: italic; color: var(--ink); margin-bottom: 0.5rem; }
.confirm-sub   { font-family: var(--mono); font-size: 0.58rem; color: var(--muted); letter-spacing: 0.06em; margin-bottom: 1.25rem; line-height: 1.6; }
.confirm-btns  { display: flex; gap: 0.5rem; }
.confirm-btn   { flex: 1; padding: 0.55rem; font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; border: none; cursor: pointer; transition: opacity 0.15s; }
.confirm-btn:hover { opacity: 0.82; }
.confirm-btn.del    { background: var(--red-rule); color: white; }
.confirm-btn.cancel { background: var(--border); color: var(--muted); }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast {
  position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 800;
  background: var(--forest); color: #d8ead0;
  border: 1px solid var(--forest-lt); padding: 0.65rem 1rem;
  font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.08em;
  opacity: 0; transform: translateY(6px);
  transition: opacity 0.2s, transform 0.2s; pointer-events: none; max-width: 300px;
}
#toast.show { opacity: 1; transform: translateY(0); }

/* â”€â”€ Loading skeletons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skel-entry { height: 140px; margin-bottom: 1.25rem; background: linear-gradient(90deg, var(--page2) 25%, var(--border) 50%, var(--page2) 75%); background-size: 400%; animation: skelly 1.4s ease infinite; }
@keyframes skelly { 0%{background-position:100%} 100%{background-position:-100%} }
</style>
</head>
<body>

<!-- â•â•â• OVERLAYS â•â•â• -->

<!-- Composer -->
<div id="composer-overlay" onclick="closeComposerOnBg(event)">
  <div class="composer-panel">
    <div class="composer-top">
      <div class="composer-heading" id="composer-heading">New Journal Entry</div>
      <button class="composer-close" onclick="closeComposer()">âœ•</button>
    </div>
    <div class="composer-body">

      <!-- Date + Mood row -->
      <div class="cf-row">
        <div class="cf-group" style="max-width:160px;">
          <div class="cf-label">Date</div>
          <input type="date" class="cf-input" id="cf-date"/>
        </div>
        <div class="cf-group">
          <div class="cf-label">Garden Mood</div>
          <select class="cf-select" id="cf-mood">
            <option value="">â€” Select â€”</option>
            <option value="thriving">ğŸŒ¿ Thriving</option>
            <option value="hopeful">ğŸŒ± Hopeful</option>
            <option value="concerned">ğŸ‚ Concerned</option>
            <option value="observing">ğŸ” Observing</option>
            <option value="celebratory">ğŸŒ¸ Celebratory</option>
          </select>
        </div>
      </div>

      <!-- Weather auto-fill -->
      <div>
        <div class="cf-label" style="margin-bottom:0.4rem;">Weather Note</div>
        <div class="weather-autofill">
          <input type="text" class="cf-input" id="cf-weather" placeholder="e.g. Sunny, 68Â°F â€” calm wind" style="flex:1;font-size:0.75rem;"/>
          <button onclick="autoFillWeather()" style="padding:0.45rem 0.7rem;border:1px solid var(--border);background:transparent;cursor:pointer;font-family:var(--mono);font-size:0.52rem;color:var(--muted);transition:all 0.15s;" onmouseover="this.style.borderColor='var(--forest)';this.style.color='var(--forest)';" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)';">â†» Auto</button>
        </div>
      </div>

      <!-- Title -->
      <div class="cf-group">
        <div class="cf-label">Entry Title <span style="color:var(--faint)">(optional)</span></div>
        <input type="text" class="cf-input" id="cf-title" placeholder="e.g. Hardening off the tomato seedlingsâ€¦"/>
      </div>

      <!-- Body -->
      <div class="cf-group">
        <div class="cf-label">Journal Entry</div>
        <textarea class="cf-textarea" id="cf-body" placeholder="Write freely. What did you notice, feel, or decide today in the garden?" oninput="updateWordCount()"></textarea>
        <div class="wc-display" id="wc-display">0 words</div>
      </div>

      <!-- Plant tags -->
      <div>
        <div class="cf-label" style="margin-bottom:0.5rem;">Tag Plants</div>
        <div class="plant-picker" id="plant-picker">
          <div style="font-family:var(--mono);font-size:0.55rem;color:var(--faint);">Loading plantsâ€¦</div>
        </div>
      </div>

      <!-- Custom tags -->
      <div>
        <div class="cf-label" style="margin-bottom:0.4rem;">Custom Tags</div>
        <div class="tag-input-wrap">
          <input type="text" class="tag-input" id="tag-input" placeholder="observation, pest, weatherâ€¦" onkeydown="if(event.key==='Enter'){event.preventDefault();addTag();}"/>
          <button class="tag-add-btn" onclick="addTag()">+ Add</button>
        </div>
        <div class="tags-display" id="tags-display"></div>
      </div>

      <!-- Photo upload -->
      <div>
        <div class="cf-label" style="margin-bottom:0.4rem;">Attach Photo</div>
        <div class="photo-drop" id="photo-drop">
          <input type="file" id="cf-photo" accept="image/*" onchange="handlePhotoSelect(event)"/>
          <div class="photo-drop-label">ğŸ“· Click to attach a photo from this entry</div>
          <img id="photo-preview-img" class="photo-preview" style="display:none;"/>
          <button class="photo-clear" id="photo-clear-btn" style="display:none;" onclick="clearPhoto(event)">âœ• Remove</button>
        </div>
      </div>

    </div>

    <div class="composer-footer">
      <div class="draft-status" id="draft-status">Draft auto-saved</div>
      <div style="display:flex;gap:0.5rem;">
        <button class="confirm-btn cancel" onclick="closeComposer()" style="padding:0.5rem 1rem;">Cancel</button>
        <button class="save-btn" id="save-btn" onclick="saveEntry()">Save Entry</button>
      </div>
    </div>
  </div>
</div>

<!-- Entry reader -->
<div id="reader-overlay" onclick="closeReaderOnBg(event)">
  <div class="reader-panel" id="reader-panel">
    <button class="reader-close" onclick="closeReader()">âœ•</button>
    <div class="reader-date" id="reader-date"></div>
    <div class="reader-title" id="reader-title"></div>
    <img class="reader-photo" id="reader-photo" style="display:none;"/>
    <div class="reader-body" id="reader-body"></div>
    <div class="reader-footer" id="reader-footer"></div>
  </div>
</div>

<!-- Delete confirm -->
<div id="confirm-dialog">
  <div class="confirm-box">
    <div class="confirm-title">Delete this entry?</div>
    <div class="confirm-sub" id="confirm-sub">This journal entry will be permanently removed. This cannot be undone.</div>
    <div class="confirm-btns">
      <button class="confirm-btn cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-btn del"    onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- â•â•â• TOP BAR â•â•â• -->
<div class="top-bar">
  <div class="logo-block">
    <div class="logo-eye">GardenHub OS // v10.6</div>
    <div class="logo-name">Garden <em>Journal</em></div>
  </div>
  <nav>
    <a href="index.html"        class="nav-link">Dashboard</a>
    <a href="map.html"          class="nav-link">Map</a>
    <a href="insights.html"     class="nav-link">Insights</a>
    <a href="clinic.html"       class="nav-link">Clinic</a>
    <a href="library.html"      class="nav-link">Library</a>
    <a href="calendar.html"     class="nav-link">Calendar</a>
    <a href="achievements.html" class="nav-link">Medals</a>
    <a href="journal.html"      class="nav-link active">Journal</a>
    <a href="snapshot.html"    class="nav-link">Snapshot</a>
    <button class="nav-link danger" id="logout-btn">Logout</button>
  </nav>
</div>

<!-- â•â•â• LAYOUT â•â•â• -->
<div class="layout">

  <!-- Sidebar -->
  <div class="sidebar">

    <div class="sb-section">
      <div class="sb-label">Search</div>
      <input type="text" class="sb-search" id="search-input" placeholder="Search entriesâ€¦" oninput="applyFilters()"/>
    </div>

    <div class="sb-section">
      <div class="sb-label">Mood</div>
      <div class="filter-chip" data-mood="thriving"    onclick="toggleMoodFilter(this)"><span class="chip-dot" style="background:var(--mood-thriving)"></span>Thriving</div>
      <div class="filter-chip" data-mood="hopeful"     onclick="toggleMoodFilter(this)"><span class="chip-dot" style="background:var(--mood-hopeful)"></span>Hopeful</div>
      <div class="filter-chip" data-mood="concerned"   onclick="toggleMoodFilter(this)"><span class="chip-dot" style="background:var(--mood-concerned)"></span>Concerned</div>
      <div class="filter-chip" data-mood="observing"   onclick="toggleMoodFilter(this)"><span class="chip-dot" style="background:var(--mood-observing)"></span>Observing</div>
      <div class="filter-chip" data-mood="celebratory" onclick="toggleMoodFilter(this)"><span class="chip-dot" style="background:var(--mood-celebratory)"></span>Celebratory</div>
    </div>

    <div class="sb-section">
      <div class="sb-label">Plant</div>
      <select class="sb-select" id="plant-filter" onchange="applyFilters()">
        <option value="">All plants</option>
      </select>
    </div>

    <div class="sb-section">
      <div class="sb-label">Month</div>
      <select class="sb-select" id="month-filter" onchange="applyFilters()">
        <option value="">All months</option>
      </select>
    </div>

    <div class="sb-section">
      <div class="sb-label">Stats</div>
      <div style="font-family:var(--mono);font-size:0.55rem;color:var(--muted);line-height:2;">
        <div>Entries: <span id="stat-total" style="color:var(--forest)">â€”</span></div>
        <div>This month: <span id="stat-month" style="color:var(--forest)">â€”</span></div>
        <div>Plants tagged: <span id="stat-plants" style="color:var(--forest)">â€”</span></div>
        <div>Streak: <span id="stat-streak" style="color:var(--forest)">â€”</span></div>
      </div>
    </div>

    <button class="new-entry-btn" onclick="openComposer()">âœ¦ New Entry</button>
  </div>

  <!-- Main journal area -->
  <main class="main">
    <div class="journal-header">
      <div class="journal-title">Field <em>Journal</em></div>
      <div class="journal-meta">
        <div id="hdr-location">Fairfield, CT Â· Zone 6b</div>
        <div id="hdr-date">â€”</div>
      </div>
    </div>

    <!-- Loading state -->
    <div id="loading-state">
      <div class="skel-entry"></div>
      <div class="skel-entry" style="animation-delay:0.1s"></div>
      <div class="skel-entry" style="animation-delay:0.2s"></div>
    </div>

    <!-- Entries rendered here -->
    <div id="entries-container" style="display:none;"></div>

  </main>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GardenHub OS â€” Garden Journal v10.6
//  Narrative field log with photo attachment,
//  plant tagging, mood tracking, and full-text search.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SUPABASE_URL = 'https://zrohwzqaksqruywiedxt.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyb2h3enFha3NxcnV5d2llZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzUwOTYsImV4cCI6MjA4NzQ1MTA5Nn0.cS8_C2WCdqH-e_ysxooH2wbarlxmi-S6CDZkevg_DPM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _entries       = [];      // all loaded entries
let _filtered      = [];      // after filter/search
let _plants        = [];      // for tag picker
let _editId        = null;    // null = new entry, uuid = editing
let _deleteId      = null;
let _selectedPlants= new Set();
let _customTags    = [];
let _photoFile     = null;
let _photoDataUrl  = null;
let _activeMoods   = new Set();
let _userId        = null;

const MOOD_ICONS = {
  thriving:'ğŸŒ¿', hopeful:'ğŸŒ±', concerned:'ğŸ‚',
  observing:'ğŸ”', celebratory:'ğŸŒ¸',
};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(iso) {
  if (!iso) return 'â€”';
  return new Date(iso + 'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}
function fmtMonthYear(iso) {
  if (!iso) return 'â€”';
  return new Date(iso + 'T12:00:00').toLocaleDateString('en-US',{month:'long',year:'numeric'});
}
function fmtMonthKey(iso) { return iso ? iso.slice(0,7) : ''; }
function today() { return new Date().toISOString().slice(0,10); }
function wordCount(txt) { return txt ? txt.trim().split(/\s+/).filter(Boolean).length : 0; }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function toast(msg, isErr = false) {
  const el = $('toast'); el.textContent = msg;
  el.style.background   = isErr ? '#5a1010' : 'var(--forest)';
  el.style.color        = isErr ? '#f8a0a0' : '#d8ead0';
  el.style.borderColor  = isErr ? '#8a2020' : 'var(--forest-lt)';
  el.className = 'show';
  clearTimeout(el._t); el._t = setTimeout(() => el.className = '', 3000);
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('logout-btn').onclick = async () => { await sb.auth.signOut(); location.reload(); };

sb.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN') { _userId = session.user.id; }
});
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) _userId = session.user.id;
  await boot();
})();

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  $('hdr-date').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  await Promise.all([loadPlants(), loadEntries()]);
}

// â”€â”€ Load library plants for tagging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlants() {
  const { data } = await sb.from('garden_library')
    .select('id,common_name,emoji').order('common_name');
  _plants = data || [];

  // Populate plant picker in composer
  $('plant-picker').innerHTML = _plants.length
    ? _plants.map(p => `
        <div class="plant-pill" data-id="${p.id}" onclick="togglePlantTag(this,'${p.id}')">
          ${p.emoji||'ğŸŒ±'} ${esc(p.common_name)}
        </div>`).join('')
    : '<div style="font-family:var(--mono);font-size:0.55rem;color:var(--faint);">No plants in library yet.</div>';

  // Populate sidebar plant filter
  $('plant-filter').innerHTML = '<option value="">All plants</option>' +
    _plants.map(p => `<option value="${p.id}">${p.emoji||'ğŸŒ±'} ${esc(p.common_name)}</option>`).join('');
}

// â”€â”€ Load entries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEntries() {
  const { data, error } = await sb.from('journal_entries')
    .select('id,entry_date,title,body,tags,plant_ids,photo_url,mood,weather_note,created_at')
    .order('entry_date', { ascending: false });

  $('loading-state').style.display = 'none';
  $('entries-container').style.display = 'block';

  if (error) {
    // Table might not exist yet â€” show friendly message
    if (error.code === '42P01') {
      $('entries-container').innerHTML = `
        <div class="empty-journal">
          <div class="big">ğŸ“–</div>
          <p>The journal table hasn't been created yet.<br/>
          Run the <strong>journal migration SQL</strong> in your Supabase editor,<br/>
          then reload this page.</p>
        </div>`;
    } else {
      $('entries-container').innerHTML = `<div class="empty-journal"><p>Error loading journal: ${esc(error.message)}</p></div>`;
    }
    return;
  }

  _entries = data || [];
  buildMonthFilter();
  computeStats();
  applyFilters();
}

// â”€â”€ Build month filter dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMonthFilter() {
  const months = [...new Set(_entries.map(e => fmtMonthKey(e.entry_date)))]
    .filter(Boolean).sort().reverse();
  $('month-filter').innerHTML = '<option value="">All months</option>' +
    months.map(m => `<option value="${m}">${fmtMonthYear(m+'-01')}</option>`).join('');
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeStats() {
  const thisMonth = today().slice(0,7);
  const monthCount = _entries.filter(e => (e.entry_date||'').startsWith(thisMonth)).length;
  const allPlantIds = new Set(_entries.flatMap(e => e.plant_ids || []));

  // Streak: consecutive days with an entry
  const entryDays = new Set(_entries.map(e => e.entry_date));
  let streak = 0;
  const d = new Date();
  while (entryDays.has(d.toISOString().slice(0,10))) {
    streak++;
    d.setDate(d.getDate()-1);
  }

  $('stat-total').textContent  = _entries.length;
  $('stat-month').textContent  = monthCount;
  $('stat-plants').textContent = allPlantIds.size;
  $('stat-streak').textContent = streak + 'd';
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMoodFilter(el) {
  const mood = el.dataset.mood;
  if (_activeMoods.has(mood)) { _activeMoods.delete(mood); el.classList.remove('on'); }
  else                         { _activeMoods.add(mood);    el.classList.add('on'); }
  applyFilters();
}

function applyFilters() {
  const search     = ($('search-input').value || '').toLowerCase().trim();
  const plantId    = $('plant-filter').value;
  const monthKey   = $('month-filter').value;

  _filtered = _entries.filter(e => {
    if (_activeMoods.size && !_activeMoods.has(e.mood)) return false;
    if (plantId && !(e.plant_ids||[]).includes(plantId))  return false;
    if (monthKey && !(e.entry_date||'').startsWith(monthKey)) return false;
    if (search) {
      const hay = ((e.title||'') + ' ' + (e.body||'') + ' ' + (e.tags||[]).join(' ')).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  renderEntries();
}

// â”€â”€ Render entries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEntries() {
  if (!_filtered.length) {
    $('entries-container').innerHTML = `
      <div class="empty-journal">
        <div class="big">ğŸŒ±</div>
        <p>${_entries.length ? 'No entries match your current filters.' : 'Your journal is empty.<br/>Click <strong>âœ¦ New Entry</strong> to write your first field note.'}</p>
      </div>`;
    return;
  }

  // Group by month
  const groups = {};
  _filtered.forEach(e => {
    const mk = fmtMonthKey(e.entry_date);
    if (!groups[mk]) groups[mk] = [];
    groups[mk].push(e);
  });

  const html = Object.entries(groups).sort((a,b) => b[0].localeCompare(a[0])).map(([mk, entries], gi) => `
    <div class="month-group">
      <div class="month-marker">
        <div class="month-name">${fmtMonthYear(mk+'-01')}</div>
        <div class="month-count">${entries.length} entr${entries.length===1?'y':'ies'}</div>
      </div>
      ${entries.map((e, ei) => renderEntryCard(e, gi*20+ei)).join('')}
    </div>`
  ).join('');

  $('entries-container').innerHTML = html;
}

function renderEntryCard(e, idx) {
  const plants = (e.plant_ids||[]).map(id => {
    const p = _plants.find(x => x.id === id);
    return p ? `<span class="entry-plant-tag">${p.emoji||'ğŸŒ±'} ${esc(p.common_name)}</span>` : '';
  }).join('');

  const tags = (e.tags||[]).map(t => `<span class="entry-tag">${esc(t)}</span>`).join('');
  const moodHtml = e.mood ? `<span class="entry-mood mood-${e.mood}">${MOOD_ICONS[e.mood]||''} ${e.mood}</span>` : '';
  const wxHtml   = e.weather_note ? `<span class="entry-weather">${esc(e.weather_note)}</span>` : '';
  const wc       = wordCount(e.body);
  const hasPhoto = !!e.photo_url;

  return `
    <div class="entry-card" id="ec-${e.id}" style="animation-delay:${idx*0.04}s" onclick="openReader('${e.id}')">
      ${hasPhoto ? `<img class="entry-photo" src="${esc(e.photo_url)}" alt="Journal photo" loading="lazy"/>` : ''}
      <div class="entry-inner">
        <div class="entry-dateline">
          <span class="entry-date">${fmtDate(e.entry_date)}</span>
          ${moodHtml}
          ${wxHtml}
        </div>
        ${e.title ? `<div class="entry-title">${esc(e.title)}</div>` : ''}
        <div class="entry-body collapsed">${esc(e.body||'')}</div>
      </div>
      <div class="entry-footer">
        <div class="entry-tags">${plants}${tags}</div>
        <div class="entry-actions">
          <span class="entry-word-count">${wc} words</span>
          <button class="entry-btn" onclick="openEditor('${e.id}',event)">Edit</button>
          <button class="entry-btn del" onclick="askDelete('${e.id}',event)">Delete</button>
        </div>
      </div>
    </div>`;
}

// â”€â”€ Reader (full entry view) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openReader(id) {
  const e = _entries.find(x => x.id === id);
  if (!e) return;

  $('reader-date').textContent = fmtDate(e.entry_date) + (e.weather_note ? ' Â· ' + e.weather_note : '');
  $('reader-title').textContent = e.title || '';
  $('reader-title').style.display = e.title ? 'block' : 'none';
  $('reader-body').textContent = e.body || '';

  const photo = $('reader-photo');
  if (e.photo_url) { photo.src = e.photo_url; photo.style.display = 'block'; }
  else              { photo.style.display = 'none'; }

  const plants = (e.plant_ids||[]).map(id => {
    const p = _plants.find(x => x.id === id);
    return p ? `<span class="entry-plant-tag">${p.emoji||'ğŸŒ±'} ${esc(p.common_name)}</span>` : '';
  }).join('');
  const tags   = (e.tags||[]).map(t => `<span class="entry-tag">${esc(t)}</span>`).join('');
  const mood   = e.mood ? `<span class="entry-mood mood-${e.mood}">${MOOD_ICONS[e.mood]||''} ${e.mood}</span>` : '';

  $('reader-footer').innerHTML = mood + plants + tags +
    `<span style="margin-left:auto;font-family:var(--mono);font-size:0.5rem;color:var(--faint);">${wordCount(e.body)} words</span>`;

  $('reader-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeReader() {
  $('reader-overlay').classList.remove('open');
  document.body.style.overflow = '';
}
function closeReaderOnBg(e) { if (e.target === $('reader-overlay')) closeReader(); }

// â”€â”€ Composer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openComposer(prefill = null) {
  _editId = prefill ? prefill.id : null;
  _selectedPlants.clear();
  _customTags = [];
  _photoFile  = null;
  _photoDataUrl = null;

  // Reset fields
  $('cf-date').value    = prefill?.entry_date || today();
  $('cf-mood').value    = prefill?.mood        || '';
  $('cf-weather').value = prefill?.weather_note|| '';
  $('cf-title').value   = prefill?.title       || '';
  $('cf-body').value    = prefill?.body        || '';
  updateWordCount();

  // Plant pills
  (prefill?.plant_ids || []).forEach(id => { _selectedPlants.add(id); });
  document.querySelectorAll('.plant-pill').forEach(el => {
    el.classList.toggle('sel', _selectedPlants.has(el.dataset.id));
  });

  // Custom tags
  _customTags = [...(prefill?.tags || [])];
  renderTagBadges();

  // Photo
  const preview = $('photo-preview-img');
  const clearBtn = $('photo-clear-btn');
  const drop = $('photo-drop');
  if (prefill?.photo_url) {
    preview.src = prefill.photo_url; preview.style.display = 'block';
    clearBtn.style.display = 'block'; drop.classList.add('has-photo');
    $('photo-drop').querySelector('.photo-drop-label').style.display = 'none';
  } else {
    preview.style.display = 'none'; clearBtn.style.display = 'none';
    drop.classList.remove('has-photo');
    $('photo-drop').querySelector('.photo-drop-label').style.display = '';
  }

  $('composer-heading').textContent = _editId ? 'Edit Entry' : 'New Journal Entry';
  $('save-btn').textContent = _editId ? 'Update Entry' : 'Save Entry';
  $('draft-status').textContent = 'Ready';

  $('composer-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';

  // Auto-fill weather if new entry
  if (!prefill) setTimeout(autoFillWeather, 400);

  // Restore draft if new entry
  if (!prefill) restoreDraft();
}

function closeComposer() {
  $('composer-overlay').classList.remove('open');
  document.body.style.overflow = '';
}
function closeComposerOnBg(e) { if (e.target === $('composer-overlay')) closeComposer(); }

function openEditor(id, e) {
  e.stopPropagation();
  const entry = _entries.find(x => x.id === id);
  if (entry) openComposer(entry);
}

// â”€â”€ Weather auto-fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function autoFillWeather() {
  const WMO = {0:'Clear',1:'Mostly clear',2:'Partly cloudy',3:'Overcast',
               45:'Foggy',51:'Light drizzle',61:'Light rain',80:'Showers',95:'Thunderstorm'};
  try {
    const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=41.1409&longitude=-73.2635&current=temperature_2m,weathercode&temperature_unit=fahrenheit&timezone=America%2FNew_York&forecast_days=1');
    const d = await r.json();
    const t = Math.round(d.current.temperature_2m);
    const desc = WMO[d.current.weathercode] || 'Clear';
    $('cf-weather').value = `${desc}, ${t}Â°F`;
  } catch { /* offline is fine */ }
}

// â”€â”€ Word count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateWordCount() {
  const wc = wordCount($('cf-body').value);
  $('wc-display').textContent = wc + (wc === 1 ? ' word' : ' words');
  autosaveDraft();
}

// â”€â”€ Draft autosave â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _draftTimer;
function autosaveDraft() {
  clearTimeout(_draftTimer);
  $('draft-status').textContent = 'Saving draftâ€¦';
  _draftTimer = setTimeout(() => {
    if (_editId) return; // don't overwrite drafts when editing
    localStorage.setItem('journal_draft', JSON.stringify({
      title: $('cf-title').value,
      body:  $('cf-body').value,
      date:  $('cf-date').value,
      mood:  $('cf-mood').value,
    }));
    $('draft-status').textContent = 'Draft saved locally';
  }, 800);
}
function restoreDraft() {
  const d = localStorage.getItem('journal_draft');
  if (!d) return;
  try {
    const draft = JSON.parse(d);
    if (draft.body && !$('cf-body').value) {
      $('cf-body').value  = draft.body;
      $('cf-title').value = draft.title || '';
      updateWordCount();
      $('draft-status').textContent = 'Draft restored';
    }
  } catch {}
}

// â”€â”€ Plant tag toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePlantTag(el, id) {
  if (_selectedPlants.has(id)) { _selectedPlants.delete(id); el.classList.remove('sel'); }
  else                          { _selectedPlants.add(id);    el.classList.add('sel'); }
}

// â”€â”€ Custom tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addTag() {
  const val = ($('tag-input').value || '').trim().toLowerCase();
  if (!val || _customTags.includes(val)) { $('tag-input').value = ''; return; }
  _customTags.push(val);
  $('tag-input').value = '';
  renderTagBadges();
}
function removeTag(tag) {
  _customTags = _customTags.filter(t => t !== tag);
  renderTagBadges();
}
function renderTagBadges() {
  $('tags-display').innerHTML = _customTags.map(t => `
    <div class="tag-badge">
      ${esc(t)}
      <span class="tag-remove" onclick="removeTag('${esc(t)}')">âœ•</span>
    </div>`).join('');
}

// â”€â”€ Photo handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handlePhotoSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('Photo must be under 5MB', true); return; }
  _photoFile = file;
  const reader = new FileReader();
  reader.onload = (e) => {
    _photoDataUrl = e.target.result;
    const preview = $('photo-preview-img');
    preview.src = _photoDataUrl; preview.style.display = 'block';
    $('photo-clear-btn').style.display = 'block';
    $('photo-drop').classList.add('has-photo');
    $('photo-drop').querySelector('.photo-drop-label').style.display = 'none';
  };
  reader.readAsDataURL(file);
}
function clearPhoto(e) {
  e.stopPropagation();
  _photoFile = null; _photoDataUrl = null;
  $('cf-photo').value = '';
  $('photo-preview-img').style.display = 'none';
  $('photo-clear-btn').style.display = 'none';
  $('photo-drop').classList.remove('has-photo');
  $('photo-drop').querySelector('.photo-drop-label').style.display = '';
}

// â”€â”€ Save / update entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveEntry() {
  const body = ($('cf-body').value || '').trim();
  if (!body) { toast('Entry body cannot be empty', true); return; }

  const btn = $('save-btn');
  btn.disabled = true; btn.textContent = 'Savingâ€¦';

  let photoUrl = null;

  // Upload photo to Supabase Storage if a new file was selected
  if (_photoFile) {
    const ext  = _photoFile.name.split('.').pop() || 'jpg';
    const path = `${_userId || 'anon'}/${Date.now()}.${ext}`;
    const { data: upData, error: upErr } = await sb.storage
      .from('journal-photos')
      .upload(path, _photoFile, { upsert: true });
    if (upErr) {
      toast('Photo upload failed: ' + upErr.message, true);
      btn.disabled = false; btn.textContent = _editId ? 'Update Entry' : 'Save Entry';
      return;
    }
    const { data: urlData } = sb.storage.from('journal-photos').getPublicUrl(path);
    photoUrl = urlData?.publicUrl || null;
  } else if (_editId) {
    // Editing: keep existing photo unless cleared
    const existing = _entries.find(e => e.id === _editId);
    if (existing && !_photoDataUrl) photoUrl = null; // user cleared it
    else if (existing) photoUrl = existing.photo_url; // unchanged
  }

  const payload = {
    entry_date:   $('cf-date').value || today(),
    title:        ($('cf-title').value || '').trim() || null,
    body,
    mood:         $('cf-mood').value || null,
    weather_note: ($('cf-weather').value || '').trim() || null,
    plant_ids:    [..._selectedPlants],
    tags:         _customTags,
    photo_url:    photoUrl,
  };
  if (_userId) payload.user_id = _userId;

  let error;
  if (_editId) {
    ({ error } = await sb.from('journal_entries').update(payload).eq('id', _editId));
  } else {
    ({ error } = await sb.from('journal_entries').insert([payload]));
  }

  btn.disabled = false; btn.textContent = _editId ? 'Update Entry' : 'Save Entry';

  if (error) {
    toast('Error saving entry: ' + error.message, true);
    return;
  }

  // Clear draft
  if (!_editId) localStorage.removeItem('journal_draft');
  closeComposer();
  toast(_editId ? 'âœ“ Entry updated' : 'âœ“ Entry saved');
  await loadEntries();
}

// â”€â”€ Delete flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function askDelete(id, e) {
  e.stopPropagation();
  _deleteId = id;
  const entry = _entries.find(x => x.id === id);
  $('confirm-sub').textContent = entry?.title
    ? `"${entry.title}" will be permanently removed.`
    : 'This journal entry will be permanently removed.';
  $('confirm-dialog').classList.add('open');
}
async function confirmDelete() {
  if (!_deleteId) return;
  const { error } = await sb.from('journal_entries').delete().eq('id', _deleteId);
  $('confirm-dialog').classList.remove('open');
  if (error) { toast('Delete failed: ' + error.message, true); return; }
  toast('Entry deleted');
  _deleteId = null;
  await loadEntries();
}
function closeConfirm() {
  $('confirm-dialog').classList.remove('open');
  _deleteId = null;
}
</script>
</body>
</html>
