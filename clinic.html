<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Clinic | GardenHub Hartford</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --pest-red: #e76f51;
            --disease-blue: #457b9d;
            --leaf-green: #2a9d8f;
            --bg: #f8fafc;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #334155; }

        /* Clinic Diagnostic Cards */
        .clinic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: all 0.3s ease;
            border-top: 10px solid #cbd5e1;
        }

        .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .card.pest { border-top-color: var(--pest-red); }
        .card.disease { border-top-color: var(--disease-blue); }

        .card.at-risk {
            outline: 3px solid var(--leaf-green);
            background: #f0fdfa;
        }

        .risk-badge {
            background: var(--leaf-green);
            color: white;
            font-size: 10px;
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 8px;
            position: absolute;
            top: 15px;
            left: 20px;
            text-transform: uppercase;
        }

        .type-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .pest .type-badge { background: var(--pest-red); }
        .disease .type-badge { background: var(--disease-blue); }

        .fix-box {
            background: white;
            padding: 15px;
            border-radius: 16px;
            border-left: 4px solid var(--leaf-green);
            font-size: 0.9rem;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Library Row Styles */
        #library-vault {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .plant-row {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            cursor: pointer;
        }
        .plant-row:hover {
            border-color: var(--leaf-green);
            background: #f0fdfa;
        }
    </style>
</head>
<body class="p-4 md:p-8">

<header class="max-w-4xl mx-auto text-center mb-12">
    <div class="flex justify-between items-center mb-6">
        <a href="index.html" class="text-green-600 font-black text-xs uppercase tracking-widest hover:underline">‚Üê Dashboard</a>
        <a href="map.html" class="text-slate-400 font-black text-xs uppercase tracking-widest hover:underline">Spatial Map ‚Üí</a>
    </div>
    <h1 class="text-4xl font-black text-slate-800 tracking-tighter mb-2">Hartford <span class="text-green-600">Clinic</span></h1>
    <p class="text-slate-500 font-medium">Smart diagnosis for Zone 6B gardening.</p>
</header>

<div class="max-w-xl mx-auto mb-12">
    <div class="relative">
        <input type="text" id="clinicSearch" placeholder="Search by plant (e.g. Tomato) or symptom..." 
               class="w-full p-5 pl-12 bg-white border-2 border-slate-200 rounded-3xl shadow-sm focus:ring-4 focus:ring-green-500/10 focus:border-green-500 outline-none transition-all">
        <span class="absolute left-5 top-5 text-slate-400">üîç</span>
    </div>
</div>

<section class="max-w-4xl mx-auto mb-16">
    <div class="flex justify-between items-end mb-6 px-2">
        <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Your Cloud Library Vault</h2>
        <p id="active-risk-count" class="text-[10px] font-bold text-green-600 uppercase italic">Syncing...</p>
    </div>
    <div id="library-vault" class="space-y-2">
        </div>
</section>

<section class="max-w-6xl mx-auto">
    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 px-2 text-center">Diagnostic Database</h2>
    <div class="clinic-grid" id="clinicGrid"></div>
</section>

<script>
    const _supabase = supabase.createClient('YOUR_URL', 'YOUR_KEY');

    const CLINIC_DB = [
        {
            name: "Tomato Hornworm",
            type: "pest",
            target: ["Tomato", "Pepper"],
            symptoms: "Large holes in leaves, missing stems, dark green droppings on foliage.",
            fix: "Hand-pick caterpillars (check under leaves) or use Bacillus thuringiensis (Bt) spray.",
            peak: "July - August"
        },
        {
            name: "Aphids",
            type: "pest",
            target: ["Lettuce", "Broccoli", "Kale"],
            symptoms: "Tiny green/black bugs on undersides of leaves, sticky residue, curling growth.",
            fix: "Blast plants with a strong stream of water or use insecticidal soap/Neem oil.",
            peak: "May - June & September"
        },
        {
            name: "Early Blight",
            type: "disease",
            target: ["Tomato", "Potato"],
            symptoms: "Brown spots on older leaves with 'target' ring patterns. Yellowing halos.",
            fix: "Prune lower branches to prevent soil splash. Use copper-based fungicide if severe.",
            peak: "July (After heavy rain)"
        },
        {
            name: "Powdery Mildew",
            type: "disease",
            target: ["Zucchini", "Squash", "Broccoli"],
            symptoms: "White, flour-like dust covering leaves. Stunted growth.",
            fix: "Mix 1 part milk with 9 parts water; spray on leaves in direct sunlight. Improve airflow.",
            peak: "August - September"
        },
        {
            name: "Septoria Leaf Spot",
            type: "disease",
            target: ["Tomato"],
            symptoms: "Numerous small circular spots with dark borders and grey centers.",
            fix: "Avoid overhead watering. Remove infected bottom leaves immediately.",
            peak: "June - August"
        }
    ];

    let myFullLibrary = [];

    async function syncAndRender() {
        const { data, error } = await _supabase
            .from('garden_library')
            .select('*');

        if (!error && data) {
            myFullLibrary = data;
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const initialSearch = urlParams.get('name') || urlParams.get('search') || "";
        document.getElementById('clinicSearch').value = initialSearch;
        
        refreshUI(initialSearch);
    }

    function refreshUI(filter = "") {
        renderLibraryVault(filter);
        renderDiagnosticGrid(filter);
    }

    function renderLibraryVault(filter = "") {
        const vault = document.getElementById('library-vault');
        const searchTerm = filter.toLowerCase();
        
        const filteredPlants = myFullLibrary.filter(p => 
            p.name.toLowerCase().includes(searchTerm)
        );

        if (filteredPlants.length === 0) {
            vault.innerHTML = `<p class="text-center py-8 text-slate-400 text-xs font-bold uppercase">No matching plants in vault</p>`;
            return;
        }

        vault.innerHTML = filteredPlants.map(plant => `
            <div class="plant-row p-4 rounded-2xl flex items-center justify-between" onclick="document.getElementById('clinicSearch').value='${plant.name}'; refreshUI('${plant.name}')">
                <div class="flex items-center gap-4">
                    <span class="text-2xl">${plant.emoji || 'üå±'}</span>
                    <div>
                        <h4 class="font-black text-slate-800 text-sm uppercase">${plant.name}</h4>
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Hartford Sector 6B</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[9px] font-black text-green-600 bg-green-50 px-2 py-1 rounded-md uppercase">Vitals Clear</span>
                    <span class="text-slate-300">‚Üí</span>
                </div>
            </div>
        `).join('');
    }

    function renderDiagnosticGrid(filter = "") {
        const clinicGrid = document.getElementById('clinicGrid');
        const myGardenNames = myFullLibrary.map(p => p.name.toLowerCase());
        let riskCount = 0;
        
        clinicGrid.innerHTML = "";
        
        const filteredIssues = CLINIC_DB.filter(item => 
            item.name.toLowerCase().includes(filter.toLowerCase()) ||
            item.target.some(t => t.toLowerCase().includes(filter.toLowerCase())) ||
            item.symptoms.toLowerCase().includes(filter.toLowerCase())
        );

        filteredIssues.forEach(issue => {
            const isAtRisk = issue.target.some(t => myGardenNames.includes(t.toLowerCase()));
            if (isAtRisk) riskCount++;

            const card = document.createElement('div');
            card.className = `card ${issue.type} ${isAtRisk ? 'at-risk' : ''}`;
            
            card.innerHTML = `
                ${isAtRisk ? '<div class="risk-badge">Active Garden Threat</div>' : ''}
                <div class="type-badge">${issue.type}</div>
                <h3 class="text-xl font-black text-slate-800 mb-4 mt-4">${issue.name}</h3>
                <div class="mb-4 text-sm">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Targets</span>
                    <div class="font-bold text-slate-600">${issue.target.join(', ')}</div>
                </div>
                <div class="mb-4 text-sm">
                    <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Symptoms</span>
                    <div class="text-slate-500 italic">"${issue.symptoms}"</div>
                </div>
                <div class="fix-box">
                    <span class="block text-[10px] font-bold text-green-600 uppercase tracking-widest mb-1">Solution</span>
                    <div class="font-medium text-slate-700 text-xs">${issue.fix}</div>
                </div>
            `;
            clinicGrid.appendChild(card);
        });

        document.getElementById('active-risk-count').innerText = 
            myFullLibrary.length ? `${riskCount} detected threats for your garden` : "Add plants to your library to track threats";
    }

    document.getElementById('clinicSearch').addEventListener('input', (e) => refreshUI(e.target.value));
    window.onload = syncAndRender;
</script>
</body>
</html>
